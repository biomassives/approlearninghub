<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="title-admin">Admin Panel | Approvideo</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="/js/dashboard-translations.js"></script>
</head>

<body>
  <header>
    <h1 id="title-admin">Admin Panel</h1>
    <button id="logout-btn">Logout</button>
  </header>

  <main class="container">
    <p id="admin-welcome">Welcome, Admin. Manage users and review system metrics below.</p>
    <div id="welcome-content"></div>
    <div id="user-list">Loading users...</div>

    <section id="translation-queue">
      <h2>Translation Suggestions Queue</h2>
      <p>Below are translations needing review and approval.</p>
      <div id="suggestion-list">Loading suggestions...</div>
    </section>

    <section id="translation-invitations">
      <h2>Send Translation Request</h2>
      <form id="invite-form">
        <label>Email of Invitee:</label>
        <input type="email" id="invite-email" required />
        <label>Language:</label>
        <input type="text" id="invite-lang" required />
        <label>Translation Key:</label>
        <input type="text" id="invite-key" required />
        <label>Suggested Role:</label>
        <select id="invite-role">
          <option value="reviewer">Reviewer</option>
          <option value="editor">Editor</option>
        </select>
        <button type="submit">Send Invitation</button>
      </form>
      <div id="invite-status"></div>
    </section>

    <div id="settings-message-container" class="message"></div>
  </main>

  <script type="module" src="/js/admin-dashboard.js"></script>
  <script type="module">
    import { requireAuth, getCurrentUser, checkAccess, signOut, updateUserRole } from './supabase-auth.js';
    import { showMessage, showToast } from './shared-utils.js';

    const userList = document.getElementById('user-list');
    const logoutBtn = document.getElementById('logout-btn');
    const suggestionList = document.getElementById('suggestion-list');
    const inviteForm = document.getElementById('invite-form');
    const inviteStatus = document.getElementById('invite-status');

    logoutBtn.addEventListener('click', async () => {
      const result = await signOut();
      if (result.success) {
        window.location.href = '/login.html';
      } else {
        showToast('Logout failed', 'error');
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      const isAuthenticated = await requireAuth();
      if (!isAuthenticated) return;

      const user = await getCurrentUser();
      const access = await checkAccess('admin')();
      if (!access.allowed) {
        showToast('Access denied: Admins only', 'error');
        window.location.href = '/dashboard.html';
        return;
      }

      loadUsers();
      loadWelcomeContent();
      loadTranslationSuggestions();
    });

    async function loadTranslationSuggestions() {
      try {
        const res = await fetch('/data/translation-suggestions.json');
        const suggestions = await res.json();
        suggestionList.innerHTML = '';

        if (!suggestions.length) {
          suggestionList.textContent = 'No suggestions pending review.';
          return;
        }

        suggestions.slice(-50).reverse().forEach((s, index) => {
          const div = document.createElement('div');
          div.className = 'suggestion-entry';
          div.innerHTML = `
            <div><strong>${s.key}</strong> (${s.lang})</div>
            <div><em>Suggested:</em> ${s.suggestion}</div>
            <div><em>Original:</em> ${s.original || '—'}</div>
            <div><small>by ${s.userEmail} at ${new Date(s.submittedAt).toLocaleString()}</small></div>
            <button class="approve-btn" data-index="${index}">Approve</button>
            <button class="reject-btn" data-index="${index}">Reject</button>
            <hr />
          `;
          suggestionList.appendChild(div);
        });

        suggestionList.querySelectorAll('.approve-btn').forEach(btn => {
          btn.addEventListener('click', () => handleSuggestionAction(btn.dataset.index, 'approve'));
        });
        suggestionList.querySelectorAll('.reject-btn').forEach(btn => {
          btn.addEventListener('click', () => handleSuggestionAction(btn.dataset.index, 'reject'));
        });
      } catch (error) {
        console.error('Failed to load translation suggestions:', error);
        suggestionList.textContent = 'Error loading suggestions.';
      }
    }

    function handleSuggestionAction(index, action) {
      const entry = document.querySelectorAll('.suggestion-entry')[index];
      if (!entry) return;
      entry.style.opacity = 0.3;
      entry.innerHTML += `<div><em>${action === 'approve' ? 'Approved' : 'Rejected'} ✔</em></div>`;
    }

    inviteForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('invite-email').value;
      const lang = document.getElementById('invite-lang').value;
      const key = document.getElementById('invite-key').value;
      const role = document.getElementById('invite-role').value;

      try {
        const res = await fetch('/api/admin/invite-translator', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, lang, key, role })
        });

        const result = await res.json();
        if (result.success) {
          inviteStatus.textContent = `Invitation sent to ${email}`;
          inviteStatus.style.color = 'green';
          inviteForm.reset();
        } else {
          inviteStatus.textContent = `Failed to send: ${result.error}`;
          inviteStatus.style.color = 'red';
        }
      } catch (err) {
        inviteStatus.textContent = 'Error sending invitation';
        inviteStatus.style.color = 'red';
      }
    });
  </script>
</body>

</html>
