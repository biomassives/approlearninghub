<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Megamenu - Click Outside Disabled</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Transition for the column container */
        #megamenu-columns {
            transition: opacity 0.4s ease-out, max-height 0.5s ease-out;
            overflow: hidden;
            max-height: 2000px;
            opacity: 1;
        }
        #megamenu-columns.columns-hidden {
            max-height: 0;
            opacity: 0;
        }

        /* Transition for the shared details area */
        #megamenu-details-area {
            transition: opacity 0.4s ease-out 0.1s, max-height 0.4s ease-out, margin-top 0.4s ease-out, padding-top 0.4s ease-out, visibility 0.4s ease-out, border-top-width 0.4s ease-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding-top: 0;
            visibility: hidden;
            border-top-width: 0;
        }
        #megamenu-details-area.visible {
            max-height: 1500px;
            opacity: 1;
            margin-top: 1.5rem; /* mt-6 */
            padding-top: 1.5rem; /* pt-6 */
            visibility: visible;
            border-top-width: 1px;
        }

        /* Megamenu Container transition */
        #megamenu-content {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, visibility 0.3s ease-out, margin-top 0.4s ease-out;
            transform-origin: top center;
            visibility: visible;
            position: relative;
            z-index: 10;
            margin-top: -8px;
        }
        #megamenu-content.hidden {
            opacity: 0;
            transform: scaleY(0.95) translateY(-10px);
            visibility: hidden;
            pointer-events: none;
            margin-top: -8px;
        }
        body.glossary-visible #megamenu-content {
             margin-top: 0.5rem;
        }

        /* Glossary Panel transition */
        #glossary-panel {
            transition: opacity 0.4s ease-out, max-height 0.4s ease-out, padding 0.4s ease-out, margin-bottom 0.4s ease-out, visibility 0.4s ease-out;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            visibility: hidden;
            position: relative;
            z-index: 20;
            margin-top: 0.5rem;
        }
        #glossary-panel.visible {
            max-height: 300px;
            opacity: 1;
            padding-top: 1rem;
            padding-bottom: 1rem;
            margin-bottom: -0.5rem;
            visibility: visible;
        }

        /* Header buttons */
        .header-button {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            position: relative;
            z-index: 30;
        }
        .header-button:hover { transform: translateY(-2px); }
        .header-button.active .icon-circle { filter: brightness(1.1); }
        .header-button:focus { outline: none; }
        .header-button:focus-visible .icon-circle { box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.6); }

        /* Icon circle */
        .icon-circle {
            width: 48px; height: 48px; border-radius: 9999px; display: flex;
            align-items: center; justify-content: center; margin-bottom: 0.25rem;
            transition: background 0.2s ease-in-out, box-shadow 0.2s ease-in-out, filter 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header-button:hover .icon-circle { box-shadow: 0 4px 8px rgba(0,0,0,0.15); filter: brightness(1.05); }

        /* Gradients */
        .icon-circle-shelter { background-image: linear-gradient(to bottom right, #60a5fa, #4ade80); }
        .icon-circle-water { background-image: linear-gradient(to bottom right, #22d3ee, #3b82f6); }
        .icon-circle-waste { background-image: linear-gradient(to bottom right, #4ade80, #facc15); }
        .icon-circle-energy { background-image: linear-gradient(to bottom right, #facc15, #f97316); }
        .icon-circle-health { background-image: linear-gradient(to bottom right, #f87171, #ec4899); }
        .icon-circle-food { background-image: linear-gradient(to bottom right, #22c55e, #a16207); }

        /* Tag pills */
        .tag-pill-button {
            display: inline-block; background-color: #4b5563; color: white;
            padding: 3px 10px; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;
            margin-right: 4px; margin-bottom: 4px; line-height: 1.2; cursor: pointer; border: none;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .tag-pill-button:hover { background-color: #374151; transform: translateY(-1px); }
        .tag-pill-button.active { background-color: #1d4ed8; font-weight: 600; }

        /* Subcategory toggle */
        .subcategory-toggle { transition: color 0.2s ease-in-out; }
        .subcategory-toggle.active { font-weight: 600; color: #1d4ed8; }

        /* Glossary Close Button */
        .glossary-close-button {
            position: absolute; top: 0.5rem; right: 0.75rem;
            background: rgba(255, 255, 255, 0.1); color: #e5e7eb;
            border: none; border-radius: 9999px; width: 1.75rem; height: 1.75rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .glossary-close-button:hover { background: rgba(255, 255, 255, 0.2); color: white; }

        /* Details Back Button */
        .details-back-button {
            display: inline-flex;
            align-items: center;
            background-color: #6b7280; /* gray-500 */
            color: white;
            padding: 6px 16px;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            transition: background-color 0.2s ease-in-out;
            cursor: pointer;
            border: none;
        }
        .details-back-button:hover {
            background-color: #4b5563; /* gray-600 */
        }

    </style>
</head>
<body class="bg-gray-100 pt-8 pb-16">
    <div class="max-w-7xl mx-auto px-4">
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <div class="flex items-center space-x-4">
                            <a href="index.html" class="flex items-center space-x-3 group">

                                <svg id="logoIcon" class="h-10 w-10 text-green-500 group-hover:text-green-600 transition-colors duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c.246 0 .492-.015.732-.044m-1.464 0A9.006 9.006 0 0 1 12 3c.587 0 1.159.069 1.711.193M12 3a9.006 9.006 0 0 0-7.08 2.886M12 3c.015-.01.03-.019.046-.028M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm4.016 4.016a9.003 9.003 0 0 0 -8.032 0M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"></path>
                                </svg>

                                <span class="text-xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                    Approvideo Learning Hub
                                </span>
                            </a>
                        </div>
                        <div class="flex items-center space-x-6">
                            <span id="offline-indicator" class="text-xs ml-2 font-semibold text-yellow-600 dark:text-yellow-400"></span>


                       

                            
                              <!-- Language selector container -->



                     
                        </div>
                    </div>
                </div>
        <nav class="relative">
            <div id="button-bar" class="flex flex-wrap justify-center bg-gradient-to-r from-gray-700 via-gray-800 to-gray-900 rounded-lg shadow-md p-3 gap-2 md:gap-4 relative z-30">
                </div>

            <div id="glossary-panel" class="w-[95%] md:w-[90%] max-w-4xl mx-auto bg-gray-800 text-gray-100 rounded-lg shadow-xl p-4">
                 <p class="text-center text-gray-400">Click a tag to see its definition.</p>
            </div>

            <div id="megamenu-content" class="w-[95%] md:w-[90%] max-w-4xl mx-auto bg-white rounded-b-lg shadow-xl p-6 pt-10 pb-6">
                <div id="megamenu-columns" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-8">
                    <div class="text-center text-gray-500 col-span-1 md:col-span-3">Select a category above to see details.</div>
                </div>
                <div id="megamenu-details-area" class="border-gray-200">
                    </div>
            </div>
            </nav>
    </div>

    <script>
        // --- Data ---
        const categoryData = [ /* Omitted for brevity - use previous version's data */
             {
              "area": "Shelter", "icon": "fa-home",
              "subcategories": [
                { "uniqueId": "shelter-0", "title": "Low-cost, Durable Construction Methods", "description": "Learn how to build safe, long-lasting structures using simple tools and affordable materials. Ideal for creating strong shelters in resource-limited areas.", "tags": ["construction", "low-cost", "durable", "building"], "context": "Context for durable construction: Focuses on resilience against elements and longevity with minimal upkeep.", "materials": ["Earthbags", "Bamboo", "Recycled Tires", "Superadobe"], "processSteps": ["Site Preparation & Foundation", "Wall Construction Techniques", "Roofing Options", "Finishing & Sealing"] },
                { "uniqueId": "shelter-1", "title": "Locally Available Materials", "description": "Find out how to identify and use materials from your immediate surroundings—like earth, bamboo, or recycled materials—to lower costs and support sustainability.", "tags": ["materials", "local", "sustainability", "earthship"], "context": "Why use local materials: Reduces transportation costs and carbon footprint, supports local economy, often culturally appropriate.", "materials": ["Adobe/Cob", "Rammed Earth", "Salvaged Wood", "Stone"], "processSteps": ["Material Identification & Sourcing", "Testing Suitability", "Processing & Preparation", "Integration into Building"] }
              ]
            },
            {
              "area": "Water", "icon": "fa-tint",
              "subcategories": [
                { "uniqueId": "water-0", "title": "Purification", "description": "Use household items or low-cost filters to make water safe for drinking. Includes simple boiling, sand filtering, and solar disinfection techniques.", "tags": ["clean water", "filtration", "health", "SODIS"], "context": "Importance of clean water: Prevents waterborne diseases like cholera and typhoid, crucial for overall health.", "materials": ["Sand", "Gravel", "Activated Charcoal", "Clear PET Bottle", "Cloth"], "processSteps": ["Boiling Procedure", "Building a BioSand Filter", "Solar Water Disinfection (SODIS)", "Chlorination (if applicable)"] },
                { "uniqueId": "water-1", "title": "Desalination", "description": "Build small-scale systems to turn salty or brackish water into fresh water using heat and condensation. Great for coastal or saline-prone areas.", "tags": ["salt removal", "ocean", "irrigation", "solar still"], "context": "Addressing water scarcity: Provides freshwater source where others are unavailable, vital for coastal/arid regions.", "materials": ["Black plastic sheeting", "Clear plastic/glass cover", "Collection container", "Tubing/Gutter"], "processSteps": ["Constructing a Basic Solar Still", "Optimizing Condensation", "Collection & Storage", "Maintenance"] },
                { "uniqueId": "water-2", "title": "Efficient Distribution", "description": "Design and improve gravity-fed or pump-based systems to distribute water evenly and reduce waste. Tips include pipe layout, storage tanks, and elevation tricks.", "tags": ["pipes", "delivery", "infrastructure", "gravity feed"], "context": "Reducing water loss: Ensures equitable access, conserves precious resource, minimizes energy for pumping.", "materials": ["PVC/HDPE pipes", "Storage tanks (ferrocement, plastic)", "Valves & Taps", "Pump (if needed)"], "processSteps": ["Topographical Survey & Planning", "Pipe Laying & Joining", "Tank Installation & Connection", "Leak Detection & Repair"] }
              ]
            },
             {
              "area": "Waste", "icon": "fa-recycle",
              "subcategories": [
                { "uniqueId": "waste-0", "title": "Composting", "description": "Learn how to convert organic waste into nutrient-rich soil. Includes techniques for both urban and rural settings, managing compost temperature, and using the final product.", "tags": ["composting", "organic waste", "soil improvement", "sustainability"], "context": "Recycling nutrients...", "materials": ["Organic waste", "Browns (carbon)", "Greens (nitrogen)"], "processSteps": ["Build bin", "Layer materials", "Turn pile"] },
                { "uniqueId": "waste-1", "title": "Recycling Systems", "description": "Set up community or household recycling systems to properly sort and process recyclable materials. Covers plastic, paper, glass, and metal recycling basics.", "tags": ["recycling", "waste sorting", "materials recovery"], "context": "Managing solid waste...", "materials": ["Sorting bins", "Collection bags"], "processSteps": ["Sort materials", "Clean recyclables", "Arrange collection"] },
                { "uniqueId": "waste-2", "title": "Upcycling", "description": "Transform discarded items into useful products. Learn creative approaches to reuse materials that would otherwise become waste.", "tags": ["upcycling", "creative reuse", "waste reduction"], "context": "Adding value to waste...", "materials": ["Plastic bottles", "Old tires", "Textiles"], "processSteps": ["Collect materials", "Design product", "Create"] },
                { "uniqueId": "waste-3", "title": "Wastewater Management", "description": "Build simple systems to treat and safely dispose of greywater and blackwater. Includes constructed wetlands, filtration beds, and safe handling practices.", "tags": ["wastewater", "greywater", "sanitation", "treatment"], "context": "Safe sanitation...", "materials": ["Gravel", "Sand", "Plants", "Pipes"], "processSteps": ["Site selection", "Excavation", "Layering filter media"] }
              ]
            },
            {
              "area": "Energy", "icon": "fa-solar-panel",
              "subcategories": [
                { "uniqueId": "energy-0", "title": "DIY Solar Energy", "description": "Set up your own solar panel systems for basic lighting and device charging. Covers solar panel positioning, batteries, and wiring safety.", "tags": ["solar", "DIY", "power", "off-grid"], "context": "Harnessing solar power...", "materials": ["Solar panel", "Charge controller", "Battery", "Wiring"], "processSteps": ["Mount panel", "Connect components", "Test system"] },
                { "uniqueId": "energy-1", "title": "Biogas Generation", "description": "Turn kitchen and animal waste into clean-burning gas for cooking. Learn how to build a small digester, maintain it, and safely use the gas.", "tags": ["biogas", "waste", "energy", "renewable"], "context": "Waste to energy...", "materials": ["Drum/Tank", "Pipes", "Manure/Waste"], "processSteps": ["Build digester", "Feed slurry", "Collect gas"] },
                { "uniqueId": "energy-2", "title": "Microgrids for Sustainable Power", "description": "Build small, local power systems that connect solar, wind, or battery energy to homes and clinics. Learn how to balance loads and increase energy access.", "tags": ["microgrid", "sustainability", "infrastructure"], "context": "Community power...", "materials": ["Generation sources", "Batteries", "Inverters", "Grid controller"], "processSteps": ["Assess needs", "Design system", "Install & commission"] },
                { "uniqueId": "energy-3", "title": "Hand Pressed Heat & Cooking Fuel Briquettes", "description": "DIY cook stove Fuel produced from waste combustible biomass slurry", "tags": ["cooking fuel", "upcycling", "home heating", "biomass"], "context": "Alternative cooking fuel...", "materials": ["Biomass waste", "Binder", "Press"], "processSteps": ["Prepare slurry", "Press briquettes", "Dry briquettes"] }
              ]
            },
            {
              "area": "Health", "icon": "fa-heartbeat",
              "subcategories": [
                { "uniqueId": "health-0", "title": "EMT Skills", "description": "Learn lifesaving basics such as CPR, wound dressing, splinting, and how to assess an emergency before help arrives.", "tags": ["EMT", "emergency", "first response", "CPR"], "context": "Basic life support...", "materials": ["First aid kit", "Training mannequin (optional)"], "processSteps": ["Scene safety", "Patient assessment", "Interventions (CPR, bleeding control)"] },
                { "uniqueId": "health-1", "title": "Telemedicine", "description": "Use phones and simple apps to connect with doctors remotely. Learn how to explain symptoms, send photos, and follow up with online care.", "tags": ["health", "telemedicine", "remote care", "digital health"], "context": "Accessing remote healthcare...", "materials": ["Smartphone/Computer", "Internet access"], "processSteps": ["Find provider", "Schedule appointment", "Consultation"] },
                { "uniqueId": "health-2", "title": "First Aid", "description": "Master everyday skills for cuts, burns, insect bites, and fevers. Helps reduce complications when access to a clinic is delayed.", "tags": ["first aid", "injury", "emergency", "home care"], "context": "Treating common injuries...", "materials": ["Bandages", "Antiseptic wipes", "Gauze", "Tape"], "processSteps": ["Assess injury", "Clean wound", "Dress wound"] },
                { "uniqueId": "health-3", "title": "Self-sufficient Healthcare", "description": "Set up a basic first aid station at home or in your village. Includes herbal remedies, rehydration recipes, and supply checklists.", "tags": ["health", "DIY", "self-reliance", "herbal medicine"], "context": "Community health resilience...", "materials": ["Basic medical supplies", "Local herbs", "Clean containers"], "processSteps": ["Identify needs", "Stock supplies", "Learn basic remedies"] }
              ]
            },
            {
              "area": "Food", "icon": "fa-utensils",
              "subcategories": [
                { "uniqueId": "food-0", "title": "Urban Gardening", "description": "Grow healthy vegetables in small spaces using buckets, rooftops, or window boxes. Learn how to compost and plant in cycles.", "tags": ["urban farming", "gardening", "food security", "container gardening"], "context": "Growing food in cities...", "materials": ["Containers", "Soil/Compost", "Seeds/Seedlings"], "processSteps": ["Prepare containers", "Planting", "Watering & care"] },
                { "uniqueId": "food-1", "title": "Hydro/Aero/Pesci-ponics", "description": "Use water-based growing systems to raise food without soil. Learn to mix nutrient solutions and maintain pH for healthy crops.", "tags": ["hydroponics", "water-efficient", "urban food", "aquaponics"], "context": "Soilless agriculture...", "materials": ["System components (pipes, pump)", "Nutrient solution", "Growing medium (optional)"], "processSteps": ["Assemble system", "Mix nutrients", "Monitor pH/EC"] },
                { "uniqueId": "food-2", "title": "Sustainable Agriculture Techniques", "description": "Practice crop rotation, natural pest control, and cover cropping to improve soil health and increase yields without chemicals.", "tags": ["agriculture", "sustainable", "soil health", "permaculture"], "context": "Eco-friendly farming...", "materials": ["Compost", "Cover crop seeds", "Natural pest deterrents"], "processSteps": ["Plan rotation", "Plant cover crops", "Integrated pest management"] },
                { "uniqueId": "food-3", "title": "Fungi, Algae, Insects, & Tech", "description": "Inventory and evaluation of modern and antiquity based food production", "tags": ["alternative protein", "future food", "mycology", "entomophagy"], "context": "Exploring new food sources...", "materials": ["Mushroom spawn", "Insect larvae", "Algae cultures"], "processSteps": ["Cultivation setup", "Harvesting", "Processing"] }
              ]
            }
        ];

        // --- Glossary Data ---
        const tagGlossary = { /* ... same as before ... */
             // Shelter Tags
            "construction": "The process or art of building structures.",
            "low-cost": "Achievable with minimal financial resources.",
            "durable": "Able to withstand wear, pressure, or damage; long-lasting.",
            "building": "A structure with walls and a roof, such as a house or factory.",
            "materials": "The matter from which a thing is or can be made.",
            "local": "Relating or restricted to a particular area or neighbourhood.",
            "sustainability": "Meeting the needs of the present without compromising the ability of future generations to meet their own needs, often focusing on environmental balance.",
            "earthship": "A type of passive solar house made of natural and recycled materials, pioneered by architect Michael Reynolds.",
            // Water Tags
            "clean water": "Water that is safe for drinking (potable) and other domestic uses, free from harmful contaminants.",
            "filtration": "The process of removing solid particles from a liquid or gas using a filter medium.",
            "health": "The state of being free from illness or injury; relates to practices promoting well-being.",
            "sodis": "Solar Water Disinfection: A simple method using sunlight and plastic bottles to kill harmful microbes in water.",
            "salt removal": "See 'Desalination'.",
            "ocean": "A very large expanse of sea, specifically each of the main areas into which the sea is divided geographically.",
            "irrigation": "The supply of water to land or crops to help growth, typically by means of channels.",
            "solar still": "A device that uses solar energy to evaporate water and condense the vapor to produce purified (often desalinated) water.",
            "pipes": "Tubes used to convey water, gas, oil, or other fluid substances.",
            "delivery": "The action of transporting something to a destination.",
            "infrastructure": "The basic physical and organizational structures and facilities (e.g., buildings, roads, power supplies) needed for the operation of a society or enterprise.",
            "gravity feed": "A system where a liquid flows from one point to another solely due to the force of gravity, typically from a higher point to a lower one without pumping."
         };

        // --- DOM Elements ---
        const buttonBar = document.getElementById('button-bar');
        const glossaryPanel = document.getElementById('glossary-panel');
        const megamenuContent = document.getElementById('megamenu-content');
        const megamenuColumnsContainer = document.getElementById('megamenu-columns');
        const megamenuDetailsArea = document.getElementById('megamenu-details-area');
        const bodyElement = document.body;

        let currentlyOpenTrigger = null;
        let activeSubcategoryToggle = null;
        let activeGlossaryTrigger = null;

        // --- Generate Header Buttons ---
        function generateHeaderButtons() {
             buttonBar.innerHTML = '';
            categoryData.forEach(category => {
                const button = document.createElement('button');
                button.className = 'megamenu-trigger header-button flex flex-col items-center text-white p-2 rounded-md focus:outline-none w-20';
                button.setAttribute('data-area', category.area);
                const circleDiv = document.createElement('div');
                circleDiv.className = `icon-circle icon-circle-${category.area.toLowerCase()}`;
                const icon = document.createElement('i');
                icon.className = `fas ${category.icon} fa-lg text-white`;
                const textSpan = document.createElement('span');
                textSpan.className = 'text-xs font-medium mt-1 text-center';
                textSpan.textContent = category.area;
                circleDiv.appendChild(icon);
                button.appendChild(circleDiv);
                button.appendChild(textSpan);
                buttonBar.appendChild(button);
                button.addEventListener('click', handleMegamenuToggle);
            });
        }

        // --- Populate Megamenu Columns ---
        function populateMegamenuColumns(area) {
            const category = categoryData.find(cat => cat.area === area);
            if (!category) {
                megamenuColumnsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-1 md:col-span-3">Category data not found.</div>';
                return;
            }
            megamenuColumnsContainer.innerHTML = '';
            megamenuColumnsContainer.classList.remove('columns-hidden');
            hideSubcategoryDetails();

            const columns = [[], [], []];
            category.subcategories.forEach((subcat, index) => {
                 subcat.uniqueId = subcat.uniqueId || `${area.toLowerCase()}-${index}`;
                columns[index % 3].push(subcat);
            });

            columns.forEach((columnSubcats) => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'space-y-6';
                if (columnSubcats.length > 0) {
                    columnSubcats.forEach((subcat) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'subcategory-item';
                        let tagsHtml = '';
                        if (subcat.tags && subcat.tags.length > 0) {
                            tagsHtml = '<div class="mt-2 flex flex-wrap gap-1">' +
                                subcat.tags.map(tag =>
                                    `<button class="tag-pill-button glossary-trigger" data-tag="${tag.toLowerCase()}">${tag}</button>`
                                ).join('') + '</div>';
                        }
                        itemDiv.innerHTML = `
                            <h4 class="text-md font-semibold text-gray-800 mb-1">${subcat.title}</h4>
                            <p class="text-sm text-gray-600">${subcat.description}</p>
                            ${tagsHtml}
                            <button class="subcategory-toggle text-sm text-blue-600 hover:text-blue-800 hover:underline mt-3" data-area="${area}" data-uniqueid="${subcat.uniqueId}">
                                Show More Info
                            </button>`;
                        columnDiv.appendChild(itemDiv);
                    });
                }
                megamenuColumnsContainer.appendChild(columnDiv);
            });
        }

        // --- Glossary Functions ---
        function displayGlossaryEntry(tag) {
            const definition = tagGlossary[tag] || "Definition not found for this tag.";
            const term = tag.charAt(0).toUpperCase() + tag.slice(1);
            glossaryPanel.innerHTML = `
                <button class="glossary-close-button" aria-label="Close glossary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h4 class="font-semibold text-lg text-white mb-1 pr-8">${term}</h4>
                <p class="text-sm text-gray-300">${definition}</p>
            `;
            glossaryPanel.querySelector('.glossary-close-button').addEventListener('click', hideGlossaryPanel);
            glossaryPanel.classList.add('visible');
            bodyElement.classList.add('glossary-visible');
        }

        function hideGlossaryPanel() {
            glossaryPanel.classList.remove('visible');
            bodyElement.classList.remove('glossary-visible');
            if (activeGlossaryTrigger) {
                activeGlossaryTrigger.classList.remove('active');
                activeGlossaryTrigger = null;
            }
             setTimeout(() => {
                if (!glossaryPanel.classList.contains('visible')) {
                     glossaryPanel.innerHTML = '<p class="text-center text-gray-400">Click a tag to see its definition.</p>';
                }
            }, 400);
        }

        function handleGlossaryTriggerClick(event) {
            event.stopPropagation();
            const currentButton = event.target;
            const tag = currentButton.dataset.tag;
            if (activeGlossaryTrigger === currentButton) {
                hideGlossaryPanel();
            } else {
                if (activeGlossaryTrigger) {
                    activeGlossaryTrigger.classList.remove('active');
                }
                displayGlossaryEntry(tag);
                currentButton.classList.add('active');
                activeGlossaryTrigger = currentButton;
            }
        }

        // --- Subcategory Details Functions ---
        function displaySubcategoryDetails(area, uniqueId) {
             const category = categoryData.find(cat => cat.area === area);
            const subcategory = category?.subcategories.find(sub => sub.uniqueId === uniqueId);
            if (!subcategory) {
                megamenuDetailsArea.innerHTML = '<p class="text-center text-red-500">Details not found.</p>';
                megamenuDetailsArea.classList.add('visible');
                return;
            }
            const detailsHtml = `
                <h3 class="text-xl font-semibold text-gray-800 mb-4">${subcategory.title}</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div><h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Context</h5><p class="text-sm text-gray-600">${subcategory.context || 'Details coming soon.'}</p></div>
                    <div><h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Materials</h5><ul class="list-disc list-inside text-sm text-gray-600 space-y-1">${subcategory.materials ? subcategory.materials.map(m => `<li>${m}</li>`).join('') : '<li>Details coming soon.</li>'}</ul></div>
                    <div><h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Process Steps</h5><ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">${subcategory.processSteps ? subcategory.processSteps.map(s => `<li>${s}</li>`).join('') : '<li>Details coming soon.</li>'}</ol></div>
                </div>
                <div class="mt-6 text-right"> <button class="details-back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3" />
                        </svg>
                        Back
                    </button>
                </div>
                `;
            megamenuDetailsArea.innerHTML = detailsHtml;
            megamenuColumnsContainer.classList.add('columns-hidden');
            megamenuDetailsArea.classList.add('visible');
        }

        function hideSubcategoryDetails() {
             megamenuDetailsArea.classList.remove('visible');
             megamenuColumnsContainer.classList.remove('columns-hidden');
            if (activeSubcategoryToggle) {
                activeSubcategoryToggle.classList.remove('active');
                activeSubcategoryToggle.textContent = 'Show More Info';
                activeSubcategoryToggle = null;
            }
            setTimeout(() => {
                 if (!megamenuDetailsArea.classList.contains('visible')) {
                     megamenuDetailsArea.innerHTML = '';
                 }
            }, 400);
        }

        function handleSubcategoryToggle(event) {
             event.stopPropagation();
            const currentButton = event.target;
            const area = currentButton.dataset.area;
            const uniqueId = currentButton.dataset.uniqueid;

            if (activeSubcategoryToggle === currentButton) {
                hideSubcategoryDetails();
            } else {
                if (activeSubcategoryToggle) {
                     megamenuColumnsContainer.classList.remove('columns-hidden');
                    activeSubcategoryToggle.classList.remove('active');
                    activeSubcategoryToggle.textContent = 'Show More Info';
                }
                displaySubcategoryDetails(area, uniqueId);
                currentButton.classList.add('active');
                currentButton.textContent = 'Hide Info';
                activeSubcategoryToggle = currentButton;
                if (!bodyElement.classList.contains('glossary-visible')) {
                   setTimeout(() => {
                       megamenuDetailsArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                   }, 100);
                }
            }
         }

        // --- Megamenu Toggle Logic (Main Categories) ---
        function handleMegamenuToggle(event) {
            const trigger = event.currentTarget;
            event.stopPropagation();
            const area = trigger.dataset.area;

            if (currentlyOpenTrigger === trigger) {
                megamenuContent.classList.add('hidden');
                trigger.classList.remove('active');
                currentlyOpenTrigger = null;
                hideSubcategoryDetails();
                hideGlossaryPanel();
            } else {
                if (currentlyOpenTrigger) {
                    currentlyOpenTrigger.classList.remove('active');
                }
                populateMegamenuColumns(area);
                megamenuContent.classList.remove('hidden');
                trigger.classList.add('active');
                currentlyOpenTrigger = trigger;
                 if (activeGlossaryTrigger) {
                     hideGlossaryPanel();
                 }
            }
         }

        // --- Event Delegation Setup ---
        function setupEventListeners() {
            // Delegate clicks within the megamenu columns area (for tags and toggles)
            megamenuColumnsContainer.addEventListener('click', function(event) {
                const target = event.target;
                if (target.classList.contains('glossary-trigger')) {
                    handleGlossaryTriggerClick(event);
                }
                else if (target.classList.contains('subcategory-toggle')) {
                    handleSubcategoryToggle(event);
                }
            });

            // Delegate clicks within the details area (for the back button)
            megamenuDetailsArea.addEventListener('click', function(event) {
                const target = event.target;
                if (target.closest('.details-back-button')) {
                    hideSubcategoryDetails();
                }
            });

            // --- REMOVED Outside click handler ---
            // document.addEventListener('click', (event) => {
            //      ... logic removed ...
            // });
        }

        // --- Initial Setup ---
        generateHeaderButtons();
        setupEventListeners(); // Setup delegation listeners once

    </script>

</body>
</html>
