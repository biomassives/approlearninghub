<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Expert Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="dashboard-container">
    <header class="dashboard-header">
      <h1 id="greeting">Welcome, Expert</h1>
      <button id="logout-btn">Log Out</button>
    </header>

    <!-- Tab Navigation -->
    <ul class="tabs">
      <li class="tab active" data-tab="topics">My Topics</li>
      <li class="tab" data-tab="modules">Modules</li>
      <li class="tab" data-tab="reviews">Reviews</li>
      <li class="tab" data-tab="zoom">Zoom Templates</li>
      <li class="tab" data-tab="notion">Notion Mappings</li>
      <li class="tab" data-tab="integrations">Integrations</li>
      <li class="tab hidden" data-tab="admin">Admin</li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <div id="topics" class="tab-pane active">
        <section class="dashboard-section">
          <h2>My Topics & Tags</h2>
          <div id="topics-container"></div>
          <button id="save-topics-btn">Save Topics</button>
        </section>
      </div>
      <div id="modules" class="tab-pane">
        <section class="dashboard-section">
          <h2>Assigned Learning Modules</h2>
          <div id="module-explorer-container"></div>
        </section>
      </div>
      <div id="reviews" class="tab-pane">
        <section class="dashboard-section">
          <h2>Pending Reviews</h2>
          <div id="pending-reviews-container"></div>
        </section>
      </div>
      <div id="zoom" class="tab-pane">
        <section class="dashboard-section">
          <h2>Zoom Meeting Templates</h2>
          <div id="zoom-templates-container"></div>
        </section>
      </div>
      <div id="notion" class="tab-pane">
        <section class="dashboard-section">
          <h2>Notion Workspace Mappings</h2>
          <div id="notion-integration-container"></div>
        </section>
      </div>
      <div id="integrations" class="tab-pane">
        <section class="dashboard-section">
          <h2>Integration Settings</h2>
          <div id="integration-settings-container"></div>
        </section>
      </div>
      <div id="admin" class="tab-pane">
        <section class="dashboard-section">
          <h2>Admin Module Management</h2>
          <div id="admin-module-management-container"></div>
        </section>
      </div>
    </div>

    <footer class="dashboard-footer">
      <p>Powered by Approvideo â€¢ MetaLattice Identity Enabled</p>
    </footer>
  </div>

  <script type="module">
    import DataService from './services/data-service.js';
    import CategorySelector from './components/CategorySelector.js';
    import ModuleExplorer from './components/ModuleExplorer.js';
    import PendingReviews from './components/PendingReviews.js';
    import ZoomTemplates from './components/ZoomTemplates.js';
    import NotionMappings from './components/NotionMappings.js';
    import IntegrationSettings from './components/IntegrationSettings.js';
    import AdminModuleManagement from './components/AdminModuleManagement.js';

    // Initialize DataService which handles secure /api calls and lattice JWT check
    const dataService = new DataService();

    async function initDashboard() {
      // 1. Verify session via custom Lattice JVM endpoint
      const session = await dataService.verifySession();
      if (!session || !session.user) {
        window.location.href = '/login';
        return;
      }
      const user = session.user;
      document.getElementById('greeting').textContent = `Welcome, ${user.fullName}`;

      // 2. Load topic categories and user selections
      const { data: topics } = await dataService.fetchCategories();
      const { data: selections } = await dataService.getUserTopics(user.id);
      const topicSelector = new CategorySelector(dataService);
      await topicSelector.init('topics-container', topics, selections);
      document.getElementById('save-topics-btn').addEventListener('click', async () => {
        const newSelections = topicSelector.getSelections();
        await dataService.updateUserTopics(user.id, newSelections);
        // show toast
        dataService.showToast('Topics updated successfully');
      });

      // 3. Initialize Modules panel
      const explorer = new ModuleExplorer(dataService);
      await explorer.init('module-explorer-container', { tags: selections.tags, subcategories: selections.subcategories });

      // 4. Pending Reviews
      const reviews = new PendingReviews(dataService);
      await reviews.init('pending-reviews-container', user.id);

      // 5. Zoom Templates
      const zoomTpl = new ZoomTemplates(dataService);
      await zoomTpl.init('zoom-templates-container', user.id);

      // 6. Notion Mappings
      const notionMap = new NotionMappings(dataService);
      await notionMap.init('notion-integration-container', user.id);

      // 7. Integration Settings
      const integration = new IntegrationSettings(dataService);
      await integration.init('integration-settings-container');

      // 8. Admin Panel if authorized
      if (session.user.role === 'admin') {
        document.querySelector('.tab[data-tab="admin"]').classList.remove('hidden');
        const admin = new AdminModuleManagement(dataService);
        await admin.init('admin-module-management-container');
      }

      // Tab switching logic
      const tabs = document.querySelectorAll('.tabs .tab');
      const panes = document.querySelectorAll('.tab-pane');
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const target = tab.dataset.tab;
          tabs.forEach(t => t.classList.toggle('active', t === tab));
          panes.forEach(p => p.id === target ? p.classList.add('active') : p.classList.remove('active'));
        });
      });

      // Logout
      document.getElementById('logout-btn').addEventListener('click', async () => {
        await dataService.logout();
        window.location.href = '/login';
      });
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
