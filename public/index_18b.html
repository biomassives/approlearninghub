<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Approvideo Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="index_18b.css" rel="stylesheet">

    <style>
            .floating-search-menu { display:none; }
    </style>

</head>
<body class="bg-gray-100"> 


    <header class="site-header">
        <div class="site-header-left">
            <div class="logo">ðŸŒ±</div>
            <h1><span class="green">Approvideo</span> <span class="blue">Learning Hub</span></h1>
        </div>
        <div class="site-header-right">
            <button id="openSearchHeaderButton" title="Open Search">
                <i class="fas fa-search"></i>
            </button>
            <div id="areaNavIconsMinimized" class="area-nav-icons minimized-view">
                </div>
        </div>
    </header>
    
    <div class="floating-search-menu" id="floatingSearchMenu">
        <div class="search-menu-header-bar">
            <span class="eaf-brand">EAF</span> <div class="header-controls-right">
                <button id="toggleSearchDisplayBtn" title="Collapse/Expand Search">
                    <i class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        <div class="search-main-content" id="searchMainContent">
            <div id="areaNavIconsExpanded" class="area-nav-icons expanded-view">
                </div>
            <h4 id="searchContentTitle">Search Content</h4>
            <input type="text" id="searchInput" placeholder="Search videos & modules...">
            <div id="searchResults"></div>
        </div>
    </div>






    <div id="modules-grid-container">
        <main class="modules-grid">
        </main>

        <nav id="subcategory-navigation-bar" class="bg-gray-200 p-4 mb-6 shadow-md">
            <h3 class="text-xl font-semibold text-gray-700 mb-3 text-center">Quick Navigation</h3>
            <div id="subcategory-pills-container" class="flex flex-wrap justify-center gap-3">
                </div>
        </nav>
        <div id="subcategory-preview"></div>



<div id="featured-content-container" class="mt-6 mx-auto max-w-6xl px-4">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Featured Content</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Featured Item 1: Water Distillation -->
        <div class="featured-item bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 flex flex-col">
            <div class="relative pt-[56.25%] bg-gray-100">
                <!-- Video thumbnail with play button overlay -->
                <div class="absolute inset-0 flex items-center justify-center">


                    
                    <img src="/assets/video/thumbnails/water_distillation_diy.jpg" 
                         alt="DIY Water Distillation System" 
                         class="w-full h-full object-cover"
                         onerror="this.src='https://placehold.co/600x400/e5e7eb/64748b?text=Water+Distillation'; this.onerror=null;">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-lg transform transition hover:scale-110">
                            <i class="fas fa-play text-white text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">Water</span>
                    <span class="text-gray-500 text-sm"><i class="far fa-clock mr-1"></i>14:22</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">DIY Water Distillation System</h3>
                <p class="text-gray-600 text-sm mb-3">Learn how to build an efficient water distillation system using common household materials. Perfect for emergency preparedness or off-grid living.</p>
                
                <div class="flex items-center mt-auto">
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">purification</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">desalination</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800">DIY</div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <a href="/assets/video/WATER DESALINATION notes - DHAKA.mp4" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center transition">
                    <i class="fas fa-play-circle mr-2"></i>
                    Watch Video
                    <i class="fas fa-arrow-right ml-auto"></i>
                </a>
            </div>
        </div>
        
        <!-- Featured Item 2: Rocket Stove -->
        <div class="featured-item bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 flex flex-col">
            <div class="relative pt-[56.25%] bg-gray-100">
                <!-- Video thumbnail with play button overlay -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <img src="/assets/video/thumbnails/rocket_stove_diy.jpg" 
                         alt="How to Build a Rocket Stove" 
                         class="w-full h-full object-cover"
                         onerror="this.src='https://placehold.co/600x400/e5e7eb/64748b?text=Rocket+Stove'; this.onerror=null;">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <div class="w-16 h-16 bg-amber-600 rounded-full flex items-center justify-center shadow-lg transform transition hover:scale-110">
                            <i class="fas fa-play text-white text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <span class="px-2 py-1 bg-amber-100 text-amber-800 text-xs font-semibold rounded">Energy</span>
                    <span class="text-gray-500 text-sm"><i class="far fa-clock mr-1"></i>18:35</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">How to Build a Rocket Stove</h3>
                <p class="text-gray-600 text-sm mb-3">Create a highly efficient cooking stove using minimal materials. This design burns cleanly, uses less fuel, and can be built in under an hour with common materials.</p>
                
                <div class="flex items-center mt-auto">
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">cooking</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">fuel efficiency</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800">sustainable</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2"><a href="/assets/SUPER_STOVE_AR.mp4">audio arabic</a></div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800"<a href="/assets/SUPER_STOVE_EN.mp4">audio english</a></div>

                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <a href="/assets/video/rocket_stove_diy.mp4" class="text-amber-600 hover:text-amber-800 text-sm font-medium flex items-center transition">
                    <i class="fas fa-play-circle mr-2"></i>
                    Watch Video
                    <i class="fas fa-arrow-right ml-auto"></i>
                </a>
            </div>
        </div>
        
        <div class="featured-item bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 flex flex-col">
            <div class="relative pt-[56.25%] bg-gray-100">
                <div class="absolute inset-0">
                    <div class="featured-slideshow w-full h-full">
                        <div class="slideshow-container relative bg-gray-100 rounded-lg overflow-hidden w-full h-full">
                            <div class="slideshow-slide active">
                                <div class="relative pt-[56.25%]">
                                    <img src="placeholder-solar-cooker-1.jpg" data-src="/assets/images/solar-cookers/parabolic-cooker.jpg" 
                                         alt="Parabolic Solar Cooker" class="absolute inset-0 w-full h-full object-cover transition-opacity"
                                         onerror="this.src='https://placehold.co/800x450/FEF9C3/713F12?text=Parabolic+Solar+Cooker'; this.onerror=null;">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-4">
                                        <h3 class="text-lg font-medium">Parabolic Solar Cooker</h3>
                                        <p class="text-sm">High temperature cooking with focused sunlight. Ideal for boiling and frying.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slideshow-slide">
                                <div class="relative pt-[56.25%]">
                                    <img src="placeholder-solar-cooker-2.jpg" data-src="/assets/images/solar-cookers/box-cooker.jpg" 
                                         alt="Solar Box Cooker" class="absolute inset-0 w-full h-full object-cover transition-opacity"
                                         onerror="this.src='https://placehold.co/800x450/FEF9C3/713F12?text=Solar+Box+Cooker'; this.onerror=null;">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-4">
                                        <h3 class="text-lg font-medium">Solar Box Cooker</h3>
                                        <p class="text-sm">Simple and effective design using common materials. Great for slow cooking and baking.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slideshow-slide">
                                <div class="relative pt-[56.25%]">
                                    <img src="placeholder-solar-cooker-3.jpg" data-src="/assets/images/solar-cookers/panel-cooker.jpg" 
                                         alt="Panel Solar Cooker" class="absolute inset-0 w-full h-full object-cover transition-opacity"
                                         onerror="this.src='https://placehold.co/800x450/FEF9C3/713F12?text=Panel+Solar+Cooker'; this.onerror=null;">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-4">
                                        <h3 class="text-lg font-medium">Panel Solar Cooker</h3>
                                        <p class="text-sm">Lightweight, portable design with reflective panels. Easy to build and transport.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="slideshow-slide">
                                <div class="relative pt-[56.25%]">
                                    <img src="placeholder-solar-cooker-4.jpg" data-src="/assets/images/solar-cookers/evacuated-tube-cooker.jpg" 
                                         alt="Evacuated Tube Solar Cooker" class="absolute inset-0 w-full h-full object-cover transition-opacity"
                                         onerror="this.src='https://placehold.co/800x450/FEF9C3/713F12?text=Evacuated+Tube+Solar+Cooker'; this.onerror=null;">
                                    <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white p-4">
                                        <h3 class="text-lg font-medium">Evacuated Tube Solar Cooker</h3>
                                        <p class="text-sm">Modern design using vacuum-sealed glass tubes. Efficient cooking even in moderate sunlight.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Navigation Arrows -->
                            <button class="slideshow-prev absolute top-1/2 left-4 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center z-10 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="slideshow-next absolute top-1/2 right-4 -translate-y-1/2 bg-black bg-opacity-50 hover:bg-opacity-70 text-white rounded-full w-10 h-10 flex items-center justify-center z-10 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            
                            <!-- Dots Navigation -->
                            <div class="slideshow-dots absolute bottom-16 left-0 right-0 flex justify-center space-x-2 z-10">
                                <button class="slideshow-dot active w-3 h-3 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100 transition-colors" data-index="0"></button>
                                <button class="slideshow-dot w-3 h-3 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100 transition-colors" data-index="1"></button>
                                <button class="slideshow-dot w-3 h-3 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100 transition-colors" data-index="2"></button>
                                <button class="slideshow-dot w-3 h-3 rounded-full bg-white bg-opacity-50 hover:bg-opacity-100 transition-colors" data-index="3"></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded">Energy</span>
                    <span class="text-gray-500 text-sm"><i class="far fa-clock mr-1"></i>12:48</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Simple Solar Cooker Setup</h3>
                <p class="text-gray-600 text-sm mb-3">Learn how to harness the sun's energy for cooking with this easy-to-build solar cooker. Perfect for fuel-free cooking during daylight hours in sunny regions.</p>
                
                <div class="flex items-center mt-auto">
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">solar</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">cooking</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800">zero-fuel</div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <a href="/assets/video/solar_cooker_diy.mp4" class="text-yellow-600 hover:text-yellow-800 text-sm font-medium flex items-center transition">
                    <i class="fas fa-play-circle mr-2"></i>
                    Watch Video
                    <i class="fas fa-arrow-right ml-auto"></i>
                </a>
            </div>
        </div>
            
            <div class="p-4 flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded">Energy</span>
                    <span class="text-gray-500 text-sm"><i class="far fa-clock mr-1"></i>12:48</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Simple Solar Cooker Setup</h3>
                <p class="text-gray-600 text-sm mb-3">Learn how to harness the sun's energy for cooking with this easy-to-build solar cooker. Perfect for fuel-free cooking during daylight hours in sunny regions.</p>
                
                <div class="flex items-center mt-auto">
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">solar</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">cooking</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800">zero-fuel</div>
                </div>
            </div>
            

        </div>
        
        <!-- Featured Item 4: Food Security Research -->
        <div class="featured-item bg-white rounded-lg overflow-hidden shadow-md border border-gray-200 flex flex-col">
            <div class="relative pt-[56.25%] bg-gray-100">
                <!-- Research document thumbnail -->
                <div class="absolute inset-0 flex items-center justify-center">
                    <img src="/assets/images/food_security_research.jpg" 
                         alt="Food Security Research" 
                         class="w-full h-full object-cover"
                         onerror="this.src='https://placehold.co/600x400/e5e7eb/64748b?text=Food+Security+Research'; this.onerror=null;">
                    <div class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center">
                        <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center shadow-lg transform transition hover:scale-110">
                            <i class="fas fa-file-alt text-white text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 flex-grow">
                <div class="flex justify-between items-start mb-2">
                    <span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">Food</span>
                    <span class="text-gray-500 text-sm"><i class="far fa-calendar mr-1"></i>May 2025</span>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Food Security Research: Resilient Systems</h3>
                <p class="text-gray-600 text-sm mb-3">Comprehensive study on building resilient local food systems in challenging environments. Includes case studies, practical frameworks, and implementation guidelines.</p>
                
                <div class="flex items-center mt-auto">
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">research</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800 mr-2">food systems</div>
                    <div class="bg-gray-200 px-3 py-1 rounded-full text-xs font-medium text-gray-800">resilience</div>
                </div>
            </div>
            

        </div>
    </div>
</div>

<!-- CSS styles for Featured Content -->
<style>
    .featured-item {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .featured-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    .featured-item .play-button {
        opacity: 0.9;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    
    .featured-item:hover .play-button {
        opacity: 1;
        transform: scale(1.1);
    }
</style>



    </div>

    <div id="category-content-container">
        <button id="back-to-modules-button">
             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"></path> </svg>
             Back to Modules
            </button>

           

            <div id="category-title-display"></div>
        <div id="glossary-panel">
            <p class="text-center text-gray-400">Click a tag to see its definition.</p>
        </div>
        <div id="megamenu-content">
            <div id="megamenu-columns" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-8">
                </div>
            <div id="megamenu-details-area" class="border-t border-gray-200">
                </div>
        </div>
    </div>

    <div id="video-info-panel">
        <div class="local-video-row" id="local-video-row">
             <a href="#" target="_blank" class="local-video-link" id="local-video-link">
                 <img src="https://placehold.co/40x40/fef9c3/713f12?text=MP4" alt="Local Video Thumbnail" class="local-video-thumb" id="local-video-thumb" onerror="this.src='https://placehold.co/40x40/fef9c3/713f12?text=MP4'; this.onerror=null;">
                 <span class="local-video-text">Watch local version: <span id="local-video-filename-display"></span></span>
             </a>
        </div>
        <div class="youtube-info-row">
            <div class="info-icon"><i class="fab fa-youtube"></i></div>
            <div class="info-text">
                <p class="info-url" id="info-url"><span class="placeholder-text">Hover over a video square...</span></p>
                <p class="info-title" id="info-title"></p>
                <p class="info-description" id="info-description"></p>
            </div>
        </div>
    </div>

    <script>
        let searchableItems = []; // For search functionality

// Debounce function
function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

function createAccordionItem(title, contentHtml, parentElement, defaultOpen = false) {
    if (!contentHtml || (Array.isArray(contentHtml) && contentHtml.length === 0) || (typeof contentHtml === 'string' && contentHtml.trim() === '')) {
        return; // Don't create accordion for empty content
    }

    const itemDiv = document.createElement('div');
    itemDiv.className = 'accordion-item';

    const button = document.createElement('button');
    button.className = 'accordion-button';
    button.textContent = title;

    const contentDiv = document.createElement('div');
    contentDiv.className = 'accordion-content';

    if (Array.isArray(contentHtml)) {
        const ul = document.createElement('ul');
        contentHtml.forEach(itemText => {
            const li = document.createElement('li');
            li.textContent = itemText;
            ul.appendChild(li);
        });
        contentDiv.appendChild(ul);
    } else {
        contentDiv.innerHTML = `<p>${contentHtml}</p>`; // Use innerHTML if content might have simple HTML
    }
    
    itemDiv.appendChild(button);
    itemDiv.appendChild(contentDiv);
    parentElement.appendChild(itemDiv);

    if (defaultOpen) {
        button.classList.add('active');
        contentDiv.style.maxHeight = contentDiv.scrollHeight + "px";
        contentDiv.classList.add('open');
    }

    button.addEventListener('click', function() {
        this.classList.toggle('active');
        const content = this.nextElementSibling;
        if (content.style.maxHeight && content.style.maxHeight !== "0px") {
            content.style.maxHeight = null;
            content.classList.remove('open');
        } else {
            content.style.maxHeight = content.scrollHeight + "px";
            content.classList.add('open');
        }
    });
}










// --- Global Variables & DOM Elements ---
        let categoryData = []; // holds the data fetched from the JSON file
        const modulesGridContainer = document.getElementById('modules-grid-container'); // Get homepage grid container
        const modulesGrid = modulesGridContainer.querySelector('.modules-grid'); // Get the grid itself
        const categoryContentContainer = document.getElementById('category-content-container'); // Get the container for detailed view
        const backToModulesButton = document.getElementById('back-to-modules-button'); // Get the back button
        const backToHomeLogoButton = document.getElementById('back-to-home-logo-button'); // Get the back button
        const categoryTitleDisplay = document.getElementById('category-title-display');
        const glossaryPanel = document.getElementById('glossary-panel');
        const megamenuContent = document.getElementById('megamenu-content'); // Container within category view
        const megamenuColumnsContainer = document.getElementById('megamenu-columns');
        const megamenuDetailsArea = document.getElementById('megamenu-details-area');
        const bodyElement = document.body;

        // Video Panel Elements
        const videoInfoPanel = document.getElementById('video-info-panel');
        const infoUrlEl = document.getElementById('info-url');
        const infoTitleEl = document.getElementById('info-title');
        const infoDescriptionEl = document.getElementById('info-description');
        const placeholderText = '<span class="placeholder-text">Hover over a video square...</span>';

        // Local Video Elements
        const localVideoRow = document.getElementById('local-video-row');
        const localVideoLink = document.getElementById('local-video-link');
        const localVideoThumb = document.getElementById('local-video-thumb');
        const localVideoFilenameDisplay = document.getElementById('local-video-filename-display');
        let activeSubcategoryToggle = null;
        let activeGlossaryTrigger = null;
        let allVideosFlat = []; // For flattened video data
        let currentArea = null; // Track the currently displayed area


// --- Video Panel Functions ---
function flattenVideoData(originalData) {
    let flatIndex = 0;
    allVideosFlat = []; // Reset
    originalData.forEach(area => {
        if (area.subcategories && Array.isArray(area.subcategories)) {
            area.subcategories.forEach((subcat) => {
                if (subcat.videos && Array.isArray(subcat.videos)) {
                    subcat.videos.forEach((video) => {
                        if (video && video.youtubeId) {
                            video.icon_tag_fa = video.icon_tag_fa || 'fas fa-video';
                            video.color_tag = video.color_tag || '#6c757d';
                            video.authors = video.authors || "";
                            video.researchReviewItems = video.researchReviewItems || [];
                            video.contentCreatorArchive = video.contentCreatorArchive || "";
                            video.licence = video.licence || "Standard YouTube License";
                            video.patreon = video.patreon || "";
                            video.socials = video.socials || {};
                            video.fundraiser = video.fundraiser || "";
                            video.sponsorPages = video.sponsorPages || [];
                            video.localVideoFilename = video.localVideoFilename || "";
                            video.flat_index = flatIndex++;
                            allVideosFlat.push(video);
                        } else { console.warn(`Skipping invalid video entry: ${subcat.title}`, video); }
                    });
                }
            });
        } else { console.warn(`Area "${area.area}" missing subcategories.`); }
    });
    console.log(`Flattened ${allVideosFlat.length} videos.`);
}


function populateSubcategoryPills(categories) { // Changed from categoryData to categories to avoid conflict if global categoryData is used
    const container = document.getElementById('subcategory-pills-container');
    if (!container) {
        console.error("Subcategory pills container not found!");
        return;
    }
    container.innerHTML = ''; // Clear any existing pills

    categories.forEach(category => {
        if (category.subcategories && Array.isArray(category.subcategories)) {
            category.subcategories.forEach((subcat, index) => {
                // Ensure uniqueId is present (your existing code has logic for this elsewhere, ensure it's consistent)
                // The uniqueId should ideally be part of your JSON data for each subcategory.
                // If not, you might need to generate it reliably, e.g., based on area and title or index.
                // The provided snippet shows `subcat.uniqueId = subcat.uniqueId || `<span class="math-inline">\{area\}\-</span>{index}`;` in populateMegamenuColumns.
                // Let's assume `subcat.uniqueId` exists or is generated before this point if necessary.
                // For safety, let's use a similar pattern if needed:
                const uniqueId = subcat.uniqueId || `${category.area.toLowerCase().replace(/\s+/g, '-')}-${index}`;


                const pillButton = document.createElement('button');
                pillButton.className = 'subcategory-pill bg-sky-500 text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-sky-600 transition-colors shadow focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75';

                let iconHtml = '';
                // Use parent category's Font Awesome icon if available, or a generic one.
                // Ensure Font Awesome is linked in your HTML for these icons to appear.
                if (category.icon) { // `category.icon` is for Font Awesome
                    iconHtml = `<i class="fas ${category.icon} mr-2"></i>`;
                } else if (typeof feather !== 'undefined' && category.featherIcon && feather.icons[category.featherIcon]) { // Fallback to Feather if no FA
                     iconHtml = feather.icons[category.featherIcon].toSvg({ class: 'inline-block mr-2 w-4 h-4' }); // Adjust class/size as needed
                } else {
                    iconHtml = `<i class="fas fa-tag mr-2"></i>`; // Generic fallback
                }

                pillButton.innerHTML = `${iconHtml}${subcat.title}`;
                pillButton.dataset.area = category.area.toLowerCase();
                pillButton.dataset.uniqueid = uniqueId;

                pillButton.addEventListener('click', () => {
                    const area = pillButton.dataset.area;
                    const subId = pillButton.dataset.uniqueid;

                    // 1. Show the main category view (which also populates its subcategory columns)
                    showCategoryView(area);

                    // 2. Display the specific subcategory details in the megamenu details area
                    //    And ensure the page scrolls to it smoothly.
                    //    The `displaySubcategoryDetails` function should handle updating the hash.
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            displaySubcategoryDetails(area, subId, true); // true to update hash
                            const detailsArea = document.getElementById('megamenu-details-area');
                            if (detailsArea && detailsArea.classList.contains('visible')) {
                                detailsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            } else {
                                // If detailsArea is not immediately visible, scroll to category container
                                const categoryContainer = document.getElementById('category-content-container');
                                if (categoryContainer) {
                                     categoryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }
                        }, 100); // Delay to allow DOM updates from showCategoryView
                    });
                });
                container.appendChild(pillButton);
            });
        }
    });
}



function showInfoPanel(video) {
     if (!video || !video.youtubeId) { hideInfoPanel(); return; } // Hide if invalid video

     // Local Video Row
     if (video.localVideoFilename && localVideoRow && localVideoLink && localVideoThumb && localVideoFilenameDisplay) {
         const videoPath = `/assets/video/${video.localVideoFilename}`;
         const thumbPath = `/assets/video/thumbnails/${video.localVideoFilename.replace(/\.[^/.]+$/, "")}.jpg`;
         localVideoLink.href = videoPath;
         localVideoThumb.src = thumbPath;
         localVideoThumb.alt = `Thumbnail for ${video.title}`;
         localVideoFilenameDisplay.textContent = video.localVideoFilename;
         localVideoRow.classList.add('visible');
     } else if(localVideoRow) {
         localVideoRow.classList.remove('visible');
     }

     // YouTube Info Row - FIX: Correct the URL format
     const youtubeWatchUrl = `https://www.youtube.com/watch?v=${video.youtubeId}`;
     infoUrlEl.textContent = youtubeWatchUrl;
     infoUrlEl.href = youtubeWatchUrl; // Make clickable
     infoUrlEl.classList.remove('placeholder-text');
     infoTitleEl.textContent = video.title || 'No Title';
     infoDescriptionEl.textContent = video.description || 'No Description';

     videoInfoPanel.classList.add('visible');
}

function hideInfoPanel() {
    infoUrlEl.innerHTML = placeholderText; infoUrlEl.removeAttribute('href');
    infoTitleEl.textContent = ''; infoDescriptionEl.textContent = '';
    if (localVideoRow) { localVideoRow.classList.remove('visible'); }
    if (localVideoLink) { localVideoLink.href = '#'; }
    if (localVideoThumb) { localVideoThumb.src = 'https://placehold.co/40x40/fef9c3/713f12?text=MP4'; localVideoThumb.alt = 'Local Video Thumbnail'; }
    if (localVideoFilenameDisplay) { localVideoFilenameDisplay.textContent = ''; }
    videoInfoPanel.classList.remove('visible');
}

function generateHomepageModules() {
    // Assuming 'modulesGrid' is already defined in your scope
    if (!modulesGrid) {
        console.error('Error: modulesGrid element not found.');
        return;
    }
    modulesGrid.innerHTML = ''; // Clear previous content

    if (!categoryData || !Array.isArray(categoryData)) {
        console.error('Error: categoryData is not available or not an array.');
        return;
    }

    categoryData.forEach(category => {
        const moduleDiv = document.createElement('div');
        const categorySlug = category.area ? category.area.toLowerCase().replace(/\s+/g, '-') : 'unknown-area';
        moduleDiv.className = `module homepage-module-item ${categorySlug}`;
        
        const iconContainer = document.createElement('div');
        iconContainer.className = 'icon';

        let iconSet = false;

        // 1. Prioritize svgString
        if (category.svgString && typeof category.svgString === 'string' && category.svgString.trim().startsWith('<svg')) {
            iconContainer.innerHTML = category.svgString;
            const svgElement = iconContainer.querySelector('svg');
            if (svgElement) {
                svgElement.classList.add('custom-svg-icon');
            }
            iconSet = true;
        }
        
        // 2. Fallback to Feather Icons
        if (!iconSet && typeof feather !== 'undefined' && feather.icons && category.featherIcon && feather.icons[category.featherIcon]) {
            try {
                iconContainer.innerHTML = feather.icons[category.featherIcon].toSvg();
                const svgElement = iconContainer.querySelector('svg');
                if (svgElement) {
                     svgElement.classList.add('feather-svg-icon');
                }
                iconSet = true;
            } catch (e) {
                console.error(`Error rendering Feather icon "${category.featherIcon}" for ${category.area || 'Unknown Area'}:`, e);
            }
        }

        // 3. Fallback to Font Awesome
        if (!iconSet && category.icon) {
            iconContainer.innerHTML = `<i class="fas ${category.icon}"></i>`;
            iconSet = true;
        }

        // 4. Generic Fallback
        if (!iconSet) {
            console.warn(`No icon specified for category: ${category.area || 'Unknown Area'}. Using default.`);
            iconContainer.innerHTML = `<i class="fas fa-shapes"></i>`;
        }

        const titleH2 = document.createElement('h2');
        titleH2.textContent = category.area || "Untitled Area";

        moduleDiv.appendChild(iconContainer);
        moduleDiv.appendChild(titleH2);

        // ***** ADD PREVIEW DIV PLACEHOLDER *****
        const subcategoryPreviewDiv = document.createElement('div');
        // Assign a class or ID that toggleSubcategoryPreview will use to find it.
        // Option 1: Using a class name (recommended if multiple previews)
        subcategoryPreviewDiv.className = 'subcategory-preview-content'; 
        // Option 2: Using a unique ID (if toggleSubcategoryPreview uses getElementById)
        // subcategoryPreviewDiv.id = `preview-${categorySlug}`;
        
        subcategoryPreviewDiv.style.display = 'none'; // Initially hidden
        moduleDiv.appendChild(subcategoryPreviewDiv);
        // *****************************************

        modulesGrid.appendChild(moduleDiv);

        moduleDiv.addEventListener('click', (event) => {
            if (event.target.closest('.subcategory-preview-link')) {
                return; 
            }
            if (typeof toggleSubcategoryPreview === 'function') {
                // Pass the moduleDiv (which now contains the preview placeholder)
                // and the category or its slug.
                toggleSubcategoryPreview(moduleDiv, category); // Pass the whole category object or just the slug
            } else {
                console.warn('toggleSubcategoryPreview function not found, but module was clicked.');
                if (typeof showCategoryView === 'function' && category.area) {
                    showCategoryView(category.area.toLowerCase());
                }
            }
        });
    });
}

function toggleSubcategoryPreview(moduleElement, areaName) {


    const previewDiv = moduleElement.querySelector('.subcategory-preview-content');
    const isActive = moduleElement.classList.contains('preview-active');

    // Hide any other open previews
    document.querySelectorAll('.homepage-module.preview-active').forEach(activeModule => {
        if (activeModule !== moduleElement) {
            activeModule.classList.remove('preview-active');

            activeModule.querySelector('.subcategory-preview-content').innerHTML = '';
            activeModule.querySelector('.subcategory-preview-content').classList.remove('visible');

        }
    });

    if (isActive) {
        previewDiv.innerHTML = ''; // Clear content
        previewDiv.classList.remove('visible');
        moduleElement.classList.remove('preview-active');
    } else {
        const category = categoryData.find(cat => cat.area.toLowerCase() === areaName);
        if (category && category.subcategories && category.subcategories.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'subcategory-preview-list';
            category.subcategories.forEach(subcat => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = `#${areaName}@${subcat.uniqueId}`; // For hash navigation
                link.textContent = subcat.title;
                link.className = 'subcategory-preview-link';
                link.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent immediate jump
                    showCategoryView(areaName); // Show the main category view
                    // Use rAF and setTimeout to ensure DOM is ready for scrolling to detail
                    requestAnimationFrame(() => {
                        setTimeout(() => {
                            displaySubcategoryDetails(areaName, subcat.uniqueId, true);
                            const detailsArea = document.getElementById('megamenu-details-area');
                            if (detailsArea) {
                                detailsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }
                        }, 100);
                    });
                });
                li.appendChild(link);
                ul.appendChild(li);
            });
            previewDiv.appendChild(ul);
            previewDiv.classList.add('visible');
            moduleElement.classList.add('preview-active');
        } else {
            previewDiv.innerHTML = '<p class="no-subcategories-text">No subcategories available.</p>';
            previewDiv.classList.add('visible');
            moduleElement.classList.add('preview-active');
        }
    }
}

function initializeSlideshows() {
    document.querySelectorAll('.featured-slideshow').forEach(slideshow => {
        const slides = slideshow.querySelectorAll('.slideshow-slide');
        const prevBtn = slideshow.querySelector('.slideshow-prev');
        const nextBtn = slideshow.querySelector('.slideshow-next');
        const dots = slideshow.querySelectorAll('.slideshow-dot');
        
        // Skip initialization if no slides found
        if (!slides.length) {
            console.warn('No slides found in slideshow:', slideshow);
            return;
        }
        
        let currentIndex = 0;
        let intervalId = null;
        
        // Function to show a specific slide
        function showSlide(index) {
            // Handle index bounds
            if (index >= slides.length) index = 0;
            if (index < 0) index = slides.length - 1;
            
            // Update current index
            currentIndex = index;
            
            // Update slides
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === currentIndex);
            });
            
            // Update dots - make sure we only update as many dots as slides
            dots.forEach((dot, i) => {
                if (i < slides.length) {
                    dot.classList.toggle('active', i === currentIndex);
                }
            });
            
            // Load the image if it hasn't been loaded yet (lazy loading)
            const currentSlide = slides[currentIndex];
            const img = currentSlide.querySelector('img');
            if (img) {
                const dataSrc = img.getAttribute('data-src');
                if (dataSrc && img.src !== dataSrc) {
                    img.src = dataSrc;
                }
            }
            
            // Reset the auto-advance timer
            resetAutoAdvance();
        }
        
        // Function to advance to the next slide
        function nextSlide() {
            showSlide(currentIndex + 1);
        }
        
        // Function to go back to the previous slide
        function prevSlide() {
            showSlide(currentIndex - 1);
        }
        
        // Function to start auto-advancing slides
        function startAutoAdvance() {
            intervalId = setInterval(nextSlide, 5000); // Change slide every 5 seconds
        }
        
        // Function to reset auto-advance timer
        function resetAutoAdvance() {
            if (intervalId) {
                clearInterval(intervalId);
                startAutoAdvance();
            }
        }
        
        // Set up click handlers for controls
        if (prevBtn) prevBtn.addEventListener('click', prevSlide);
        if (nextBtn) nextBtn.addEventListener('click', nextSlide);
        
        // Set up click handlers for dots
        dots.forEach((dot, i) => {
            if (i < slides.length) { // Only add handlers for valid slides
                dot.addEventListener('click', () => showSlide(i));
            }
        });
        
        // Set up keyboard navigation
        slideshow.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') prevSlide();
            else if (e.key === 'ArrowRight') nextSlide();
        });
        
        // Make slideshow focusable for keyboard navigation
        slideshow.setAttribute('tabindex', '0');
        
        // Start auto-advance
        startAutoAdvance();
        
        // Pause auto-advance when user hovers over the slideshow
        slideshow.addEventListener('mouseenter', () => {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        });
        
        // Resume auto-advance when user leaves the slideshow
        slideshow.addEventListener('mouseleave', () => {
            if (!intervalId) {
                startAutoAdvance();
            }
        });
        
        // Load the first image immediately
        const firstImg = slides[0]?.querySelector('img');
        if (firstImg) {
            const firstDataSrc = firstImg.getAttribute('data-src');
            if (firstDataSrc) {
                firstImg.src = firstDataSrc;
            }
        }
        
        // Show the first slide
        showSlide(0);

        console.log(`Initialized slideshow with ${slides.length} slides`);
    });
}

// --- Hash Navigation Functions ---
// IMPORTANT: Define handleHashChange FIRST to avoid reference errors
function handleHashChange() {
    // Get the hash without the # prefix
    let hash = window.location.hash.substring(1);
    
    if (!hash) {
        showHomepageView(); // Show grid if no hash
        return;
    }

    // Normalize hash to lowercase and trim any spaces
    hash = hash.toLowerCase().trim();
    console.log(`Processing hash: ${hash}`);

    // Split the hash by @ to check for subcategory requests
    const parts = hash.split('@');
    const categoryArea = parts[0]; 
    const subcategoryId = parts.length > 1 ? parts[1] : null;

    // Find if this category exists in our data
    const categoryMatch = categoryData.find(cat => 
        cat.area.toLowerCase() === categoryArea
    );

    if (categoryMatch) {
        console.log(`Found category match for hash: #${hash}`);
        
        // Show the category view for the requested area
        showCategoryView(categoryArea);

        // If there's also a subcategory ID specified
        if (subcategoryId) {
            // Use requestAnimationFrame + setTimeout to ensure DOM is updated
            requestAnimationFrame(() => {
                setTimeout(() => {
                    console.log(`Looking for subcategory: ${subcategoryId}`);
                    
                    // Try to find the subcategory in the data first
                    const subcategoryExists = categoryMatch.subcategories.some(
                        subcat => subcat.uniqueId === subcategoryId
                    );
                    
                    if (subcategoryExists) {
                        // Display details for the requested subcategory
                        displaySubcategoryDetails(categoryArea, subcategoryId, false);
                        
                        // Scroll to details area after a short delay
                        setTimeout(() => {
                            megamenuDetailsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    } else {
                        console.warn(`Subcategory not found for hash: ${hash}. Showing category view.`);
                        // Ensure we reset the hash to just the category
                        history.pushState(null, null, '#' + categoryArea);
                    }
                }, 100);
            });
        } else {
            // Just show the category columns view (no specific subcategory)
            hideSubcategoryDetails(false);
        }
    } else {
        console.warn(`Category not found for hash: ${hash}. Showing homepage.`);
        showHomepageView(); // Fallback to homepage if invalid category
    }
}

// --- Show/Hide Views ---
function showCategoryView(area) {
    console.log("Showing category:", area);
    
    // Normalize area to lowercase
    area = area.toLowerCase();
    
    // Store current area
    currentArea = area; 
    
    // Find the category object
    const category = categoryData.find(cat => cat.area.toLowerCase() === area);
    
    if (category) {
        // Show the category title
        showCategoryTitle(category);
        
        // Populate the content columns for this area
        populateMegamenuColumns(area);
        
        // Hide the homepage modules grid
        modulesGridContainer.style.display = 'none'; 
        
        // Show the category content container
        categoryContentContainer.classList.add('visible');
        
        // Update hash if it's not already set correctly
        if (window.location.hash.substring(1).toLowerCase() !== area) {
            // Use pushState for visible URL change
            history.pushState(null, null, '#' + area);
        }
        
        // Scroll to top for better user experience
        window.scrollTo(0, 0);
    } else {
        console.error(`Category not found: ${area}`);
    }
}

function showHomepageView() {
    console.log("Showing homepage grid");
    currentArea = null; // Reset current area
    hideSubcategoryDetails(false); // Ensure details are hidden
    hideGlossaryPanel();
    hideCategoryTitle();
    modulesGridContainer.style.display = 'block'; // Show module grid
    categoryContentContainer.classList.remove('visible'); // Hide category content
    
    // Use pushState for visible URL change - remove hash
    if (window.location.hash) {
        history.pushState(null, document.title, window.location.pathname + window.location.search);
    }
}

function populateMegamenuColumns(area) {
    const category = categoryData.find(cat => cat.area.toLowerCase() === area);
    if (!category) {
        megamenuColumnsContainer.innerHTML = '<div class="text-center text-gray-500 col-span-1 md:col-span-3">Category data not found.</div>';
        return;
    }
    megamenuColumnsContainer.innerHTML = ''; // Clear previous columns
    megamenuColumnsContainer.classList.remove('columns-hidden'); // Ensure columns are potentially visible
    hideSubcategoryDetails(false); // Ensure details area is hidden when showing columns

    const columns = [[], [], []];
    category.subcategories.forEach((subcat, index) => {
         subcat.uniqueId = subcat.uniqueId || `${area}-${index}`;
         columns[index % 3].push(subcat);
    });

    columns.forEach((columnSubcats) => {
        const columnDiv = document.createElement('div');
        columnDiv.className = 'space-y-6';
        if (columnSubcats.length > 0) {
            columnSubcats.forEach((subcat) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'subcategory-item';
                let tagsHtml = '';
                if (subcat.tags && subcat.tags.length > 0) {
                    tagsHtml = '<div class="mt-2 flex flex-wrap gap-1">' +
                        subcat.tags.map(tag =>
                            `<button class="tag-pill-button glossary-trigger" data-tag="${tag.toLowerCase()}">${tag}</button>`
                        ).join('') + '</div>';
                }
                itemDiv.innerHTML = `
                    <h4 class="text-md font-semibold text-gray-800 mb-1">${subcat.title}</h4>
                    <p class="text-sm text-gray-600">${subcat.description}</p>
                    ${tagsHtml}
                    <button class="subcategory-toggle text-sm text-blue-600 hover:text-blue-800 hover:underline mt-3" data-area="${area}" data-uniqueid="${subcat.uniqueId}">
                        Show More Info
                    </button>`;
                columnDiv.appendChild(itemDiv);
            });
        }
        megamenuColumnsContainer.appendChild(columnDiv);
    });
}

// --- Glossary Functions ---
function displayGlossaryEntry(tag) {
    const definition = tagGlossary[tag] || "Definition not found for this tag.";
    const term = tag.charAt(0).toUpperCase() + tag.slice(1);
    glossaryPanel.innerHTML = `
        <button class="glossary-close-button" aria-label="Close glossary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"> <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /> </svg>
        </button>
        <h4 class="font-semibold text-lg text-white mb-1 pr-8">${term}</h4>
        <p class="text-sm text-gray-300">${definition}</p>
    `;
    glossaryPanel.querySelector('.glossary-close-button').addEventListener('click', hideGlossaryPanel);
    glossaryPanel.classList.add('visible');
    bodyElement.classList.add('glossary-visible'); // Keep this class for potential styling needs
}

function hideGlossaryPanel() {
    glossaryPanel.classList.remove('visible');
    bodyElement.classList.remove('glossary-visible');
    if (activeGlossaryTrigger) { activeGlossaryTrigger.classList.remove('active'); activeGlossaryTrigger = null; }
    setTimeout(() => { if (!glossaryPanel.classList.contains('visible')) { glossaryPanel.innerHTML = '<p class="text-center text-gray-400">Click a tag to see its definition.</p>'; } }, 400);
}

function handleGlossaryTriggerClick(event) {
    event.stopPropagation();
    const currentButton = event.target;
    const tag = currentButton.dataset.tag;
    if (activeGlossaryTrigger === currentButton) { hideGlossaryPanel(); }
    else { if (activeGlossaryTrigger) { activeGlossaryTrigger.classList.remove('active'); } displayGlossaryEntry(tag); currentButton.classList.add('active'); activeGlossaryTrigger = currentButton; }
}

// --- Subcategory Details Functions ---
function displaySubcategoryDetails(area, uniqueId, updateHash = true) {
    console.log(`Displaying subcategory details: ${area}/${uniqueId}`);
    
    const category = categoryData.find(cat => cat.area.toLowerCase() === area);
    if (!category) {
        console.error(`Category not found: ${area}`);
        megamenuDetailsArea.innerHTML = '<p>Category not found.</p>'; 
        megamenuDetailsArea.classList.add('visible');
        return;
    }
    
    const currentSubcategory = category.subcategories.find(sub => sub.uniqueId === uniqueId);
    if (!currentSubcategory) {
        console.error(`Subcategory not found: ${uniqueId}`);
        megamenuDetailsArea.innerHTML = '<p>Subcategory details not found.</p>'; 
        megamenuDetailsArea.classList.add('visible');
        return;
    }
    
    console.log("Found subcategory:", currentSubcategory.title);

    // Generate sibling links for navigation between subcategories
    let siblingLinksHtml = '';
    if (category.subcategories && category.subcategories.length > 1) {
        siblingLinksHtml = '<div class="sibling-links-container"><span>See also: </span>';
        category.subcategories.forEach(subcat => {
            if (!subcat.uniqueId) { 
                console.warn("Missing uniqueId:", subcat.title); 
                return; 
            }
            const isCurrent = subcat.uniqueId === uniqueId;
            siblingLinksHtml += `<button class="sibling-link-pill ${isCurrent ? 'current' : ''}" 
                                data-area="${area}" data-uniqueid="${subcat.uniqueId}" 
                                ${isCurrent ? 'disabled' : ''}>${subcat.title}</button>`;
        });
        siblingLinksHtml += '</div>';
    }

    // Start building the detailed content HTML
    let detailsHtml = `
        <h3 class="text-xl font-semibold text-gray-800 mb-3">${currentSubcategory.title}</h3>
        ${siblingLinksHtml}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
                <h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Context</h5>
                <p class="text-sm text-gray-600">${currentSubcategory.context || 'No context information available.'}</p>
            </div>
            <div>
                <h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Materials</h5>
                <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                    ${currentSubcategory.materials && currentSubcategory.materials.length > 0 
                        ? currentSubcategory.materials.map(m => `<li>${m}</li>`).join('') 
                        : '<li>No materials information available.</li>'}
                </ul>
            </div>
            <div>
                <h5 class="font-semibold text-md text-gray-700 mb-2 border-b pb-1">Process Steps</h5>
                <ol class="list-decimal list-inside text-sm text-gray-600 space-y-1">
                    ${currentSubcategory.processSteps && currentSubcategory.processSteps.length > 0
                        ? currentSubcategory.processSteps.map(s => `<li>${s}</li>`).join('') 
                        : '<li>No process steps information available.</li>'}
                </ol>
            </div>
        </div>`;

    // Add videos section if available
    if (currentSubcategory.videos && currentSubcategory.videos.length > 0) {
        detailsHtml += `
            <h4 class="text-lg font-semibold text-gray-700 mb-3 pt-4 border-t">Related Videos</h4>
            <div class="video-linker-container">`;
        
        currentSubcategory.videos.forEach(video => {
            // Skip invalid videos
            if (!video.youtubeId) {
                console.warn("Skipping video with missing youtubeId:", video);
                return;
            }
            
            // Ensure flat_index exists (create one if needed)
            const flatIndex = video.flat_index !== undefined ? video.flat_index : 0;
            
            // Build video link
            const youtubeWatchUrl = `https://www.youtube.com/watch?v=${video.youtubeId}`;
            const bgColor = video.color_tag || '#6c757d';
            const iconClass = video.icon_tag_fa || 'fas fa-video';
            const useNoIconFallback = !iconClass || iconClass === 'fas fa-video';
            
            detailsHtml += `
                <a href="${youtubeWatchUrl}" target="_blank" 
                   class="video-linker ${useNoIconFallback ? 'no-icon' : ''}" 
                   style="background-color: ${bgColor};" data-flat-index="${flatIndex}" 
                   title="Open video: ${video.title || 'Watch Video'}">`;
            
            if (!useNoIconFallback) { 
                detailsHtml += `<i class="${iconClass}"></i>`; 
            } else { 
                detailsHtml += (video.title || 'Video').substring(0, 15) + 
                    ((video.title && video.title.length > 15) ? '...' : ''); 
            }
            
            detailsHtml += `</a>`;
        });
        
        detailsHtml += `</div>`;
    }

    // Add share and back buttons
    detailsHtml += `
        <div class="mt-8 flex justify-between items-center"  style="height: 100px;">
            <div>
                <button class="bg-blue-600 text-white py-1 px-3 rounded text-sm share-subcategory-link" 
                        data-area="${area}" data-uniqueid="${uniqueId}">
                    <i class="fas fa-link mr-1"></i> Share Link
                </button>
            </div>
            <div>
                <button class="details-back-button">
                    <i class="fas fa-arrow-left mr-1"></i> Back to Subcategories
                </button>
            </div>
        </div>`;

    // Update the DOM
    megamenuDetailsArea.innerHTML = detailsHtml;
    megamenuColumnsContainer.classList.add('columns-hidden'); // Hide columns
    megamenuDetailsArea.classList.add('visible'); // Show details

    // Update URL hash for deep linking
    if (updateHash) {
        const newHash = `${area}@${uniqueId}`;
        history.pushState(null, null, '#' + newHash);
    }

    // Update the active state of the toggle button in the columns view
    const correspondingToggle = megamenuColumnsContainer.querySelector(
        `.subcategory-toggle[data-area="${area}"][data-uniqueid="${uniqueId}"]`
    );
    
    if (correspondingToggle) {
        if (activeSubcategoryToggle && activeSubcategoryToggle !== correspondingToggle) {
            activeSubcategoryToggle.classList.remove('active');
            activeSubcategoryToggle.textContent = 'Show More Info';
        }
        
        correspondingToggle.classList.add('active');
        correspondingToggle.textContent = 'Hide Info';
        activeSubcategoryToggle = correspondingToggle;
    }
    
    // Set up share button functionality
    setupShareButton(area, uniqueId);
}

function hideSubcategoryDetails(updateHash = true) {
    const detailsWereVisible = megamenuDetailsArea.classList.contains('visible');
    megamenuDetailsArea.classList.remove('visible');
    megamenuColumnsContainer.classList.remove('columns-hidden'); // Show columns again
    
    // Reset toggle button states
    if (activeSubcategoryToggle) {
        activeSubcategoryToggle.classList.remove('active');
        activeSubcategoryToggle.textContent = 'Show More Info';
        activeSubcategoryToggle = null;
    }
    
    // Update URL
    if (detailsWereVisible && updateHash && currentArea) {
        history.pushState(null, null, '#' + currentArea);
    }
    
    hideInfoPanel(); // Hide video panel
    
    setTimeout(() => { 
        if (!megamenuDetailsArea.classList.contains('visible')) { 
            megamenuDetailsArea.innerHTML = ''; 
        } 
    }, 400);
}

function handleSubcategoryToggle(event) {
    event.stopPropagation();
    const currentButton = event.target;
    const area = currentButton.dataset.area;
    const uniqueId = currentButton.dataset.uniqueid;
    
    if (activeSubcategoryToggle === currentButton) {
        // If the same toggle is clicked, hide details
        hideSubcategoryDetails(true);
    } else {
        // Display the subcategory details
        displaySubcategoryDetails(area, uniqueId, true);
        
        // Scroll to details area
        requestAnimationFrame(() => {
            setTimeout(() => {
                megamenuDetailsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
        });
    }
}

// --- Category Title Display Functions ---
function showCategoryTitle(category) {
    const displayName = category.area || 'Category'; // Use Area name
    categoryTitleDisplay.textContent = displayName;
    categoryTitleDisplay.classList.add('visible');
}

function hideCategoryTitle() {
    categoryTitleDisplay.classList.remove('visible');
    setTimeout(() => { if (!categoryTitleDisplay.classList.contains('visible')) { categoryTitleDisplay.textContent = ''; } }, 400);
}

// --- Sharing Functions ---
function setupShareButton(area, uniqueId) {
    const shareButton = megamenuDetailsArea.querySelector('.share-subcategory-link');
    if (shareButton) {
        shareButton.addEventListener('click', function() {
            const shareableLink = getShareableLink(area, uniqueId);
            
            // Copy the link to clipboard
            navigator.clipboard.writeText(shareableLink)
                .then(() => {
                    // Provide visual feedback
                    const originalText = shareButton.innerHTML;
                    shareButton.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
                    setTimeout(() => {
                        shareButton.innerHTML = originalText;
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    // Fallback method
                    prompt('Copy this link to share:', shareableLink);
                });
        });
    }
}

function getShareableLink(area, uniqueId) {
    const baseUrl = window.location.origin + window.location.pathname;
    return `${baseUrl}#${area.toLowerCase()}@${uniqueId}`;
}


function populateAreaNavIcons(categoriesInfo) { // Expects array like [{ name: "Area Name", svgString: "<svg...", slug: "area-slug", icon: "fa-fallback" }]
    const expandedNavContainer = document.getElementById('areaNavIconsExpanded');
    const minimizedNavContainer = document.getElementById('areaNavIconsMinimized');

    if (!expandedNavContainer || !minimizedNavContainer) {
        console.error("Area navigation icon containers ('areaNavIconsExpanded' or 'areaNavIconsMinimized') not found in the DOM. Ensure these IDs exist in your floating search menu HTML.");
        return;
    }

    expandedNavContainer.innerHTML = ''; // Clear previous icons
    minimizedNavContainer.innerHTML = ''; // Clear previous icons

    if (!categoriesInfo || categoriesInfo.length === 0) {
        console.warn("No category information provided to populateAreaNavIcons.");
        return;
    }

    categoriesInfo.forEach(areaInfo => {
        const areaSlug = areaInfo.slug; // Expecting slug like 'water', 'shelter'
        const areaDisplayName = areaInfo.name;

        if (!areaSlug || !areaDisplayName) {
            console.error("Missing slug or name in areaInfo for navigation icons:", areaInfo);
            return; // Skip this icon if essential info is missing
        }

        // Helper function to create each icon element (since we need two identical ones)
        const createIconElement = () => {
            const iconWrapper = document.createElement('div');
            iconWrapper.className = 'nav-area-icon-wrapper'; // For styling the clickable area & SVG container
            iconWrapper.title = `Go to ${areaDisplayName}`;

            if (areaInfo.svgString && typeof areaInfo.svgString === 'string' && areaInfo.svgString.trim().startsWith('<svg')) {
                iconWrapper.innerHTML = areaInfo.svgString;
                const svgElement = iconWrapper.querySelector('svg');
                if (svgElement) {
                    svgElement.classList.add('area-nav-svg'); // Add class for specific CSS targeting of the SVG
                    // Ensure SVG scales by removing fixed dimensions if CSS is to control it
                    svgElement.removeAttribute('width');
                    svgElement.removeAttribute('height');
                }
            } else {
                // Fallback if no svgString (e.g., use Font Awesome)
                const fallbackIcon = document.createElement('i');
                fallbackIcon.className = `fas ${areaInfo.icon || 'fa-folder-open'} nav-area-fallback-icon`;
                iconWrapper.appendChild(fallbackIcon);
                console.warn(`SVG string missing for area "${areaDisplayName}", using fallback icon.`);
            }

            iconWrapper.addEventListener('click', () => {
                console.log(`Header icon clicked for area: '${areaDisplayName}'. Calling showCategoryView with slug: '${areaSlug}'`);
                if (typeof showCategoryView === 'function') {
                    showCategoryView(areaSlug); // This is the key call to change the view

                    // Optionally, close/minimize the search menu after navigation
                    const floatingMenu = document.getElementById('floatingSearchMenu');
                    const toggleButton = document.getElementById('toggleSearchDisplayBtn');
                    if (floatingMenu && toggleButton && !floatingMenu.classList.contains('minimized')) {
                        toggleButton.click(); // Simulate click to trigger minimize logic
                    }
                } else {
                    console.error(`showCategoryView function is not defined! Cannot navigate to area '${areaDisplayName}'.`);
                }
            });
            return iconWrapper;
        };

        expandedNavContainer.appendChild(createIconElement());
        minimizedNavContainer.appendChild(createIconElement());
    });
    console.log("Area navigation icons populated.");
}

// --- Function to build the searchableItems array for search autocomplete ---

function buildSearchableItems(data) {
    searchableItems = []; // Reset before building
    if (!data || !Array.isArray(data)) {
        console.error("Invalid data provided to buildSearchableItems");
        return;
    }
    data.forEach(area => {
        if (!area || !area.area) return; // Skip if area or area.area is undefined

        // Add Area itself as a searchable module (if you want to search for main areas)
        // searchableItems.push({
        //     id: `area-${area.area.toLowerCase().replace(/\s+/g, '-')}`, // ID for the area section
        //     title: area.area,
        //     type: 'module', // or 'area'
        //     icon: area.icon || 'fa-cubes',
        //     areaName: area.area, // For navigation
        //     slug: area.area.toLowerCase().replace(/\s+/g, '-')
        // });

        if (area.subcategories && Array.isArray(area.subcategories)) {
            area.subcategories.forEach((subcategory, subcatIndex) => {
                if (!subcategory || !subcategory.title) return; // Skip if subcategory or title is undefined

                const subcategorySlugBase = area.area.toLowerCase().replace(/\s+/g, '-');
                const subcategoryUniqueId = subcategory.uniqueId || `${subcategorySlugBase}-${subcategory.title.toLowerCase().replace(/\s+/g, '-')}-${subcatIndex}`;
                
                // Add Subcategory to searchable items
                searchableItems.push({
                    id: `subcategory-${subcategoryUniqueId}`, // An ID for a potential element representing the subcategory
                    title: subcategory.title,
                    type: 'module', // Or 'subcategory'
                    icon: subcategory.icon || area.icon || 'fa-cube',
                    areaName: area.area,
                    areaSlug: subcategorySlugBase,
                    uniqueId: subcategoryUniqueId // Used by displaySubcategoryDetails
                });

                if (subcategory.videos && Array.isArray(subcategory.videos)) {
                    subcategory.videos.forEach((video, videoIndex) => {
                        if (video && video.youtubeId && video.title) {
                            const videoSearchableId = `video-search-${subcategoryUniqueId}-${videoIndex}`;
                            searchableItems.push({
                                id: videoSearchableId, // This ID needs to be on the video element if you want to scroll to it
                                title: video.title,
                                description: video.description || '',
                                type: 'video',
                                icon: video.icon_tag_fa || 'fa-play-circle',
                                areaName: area.area,
                                areaSlug: subcategorySlugBase,
                                subcatUniqueId: subcategoryUniqueId,
                                flat_index: video.flat_index // Useful for showInfoPanel
                                // Add youtubeId if search result click should play video directly
                                // youtubeId: video.youtubeId 
                            });
                        }
                    });
                }
            });
        }
    });
    console.log(`Built ${searchableItems.length} searchable items.`);
}

// --- Function to set up interactions for the floating search menu ---
function setupSearchMenuInteractions() {
    const openSearchHeaderButton = document.getElementById('openSearchHeaderButton');
    const floatingMenu = document.getElementById('floatingSearchMenu');
    const internalToggleBtn = document.getElementById('toggleSearchDisplayBtn');
    const searchInput = document.getElementById('searchInput');

    if (!floatingMenu || !internalToggleBtn) {
        console.error("Floating search menu (#floatingSearchMenu) or its toggle button (#toggleSearchDisplayBtn) not found.");
        return;
    }

    // Initial state: hidden & minimized (CSS handles opacity/transform, JS adds 'visible' class)
    floatingMenu.classList.add('minimized');
    // floatingMenu.classList.remove('visible'); // Start fully hidden, or manage with CSS transitions

    if (openSearchHeaderButton) {
        openSearchHeaderButton.addEventListener('click', () => {
            console.log("Open Search Header Button clicked");
            floatingMenu.classList.add('visible'); // Make it appear

            if (floatingMenu.classList.contains('minimized')) {
                internalToggleBtn.click(); // Expands it and handles icon
            } else {
                 // If already visible and expanded, maybe just focus input
                if (searchInput) setTimeout(() => searchInput.focus(), 50);
            }
        });
    }

    internalToggleBtn.addEventListener('click', () => {
        const isNowMinimized = floatingMenu.classList.toggle('minimized');
        const icon = internalToggleBtn.querySelector('i');
        if (!icon) return;

        if (isNowMinimized) {
            icon.className = 'fas fa-search'; // Or your preferred "magnifying glass" icon
            internalToggleBtn.title = 'Expand Search';
            floatingMenu.classList.remove('visible'); // Hide completely when minimized by its own button
        } else {
            icon.className = 'fas fa-chevron-up';
            internalToggleBtn.title = 'Collapse Search';
            floatingMenu.classList.add('visible'); // Ensure it's visible when expanded
            if (searchInput) setTimeout(() => searchInput.focus(), 50);
        }
    });

    // Optional: Click outside to hide the floating search menu
    document.addEventListener('click', function(event) {
        if (floatingMenu.classList.contains('visible') &&
            !floatingMenu.contains(event.target) &&
            (!openSearchHeaderButton || !openSearchHeaderButton.contains(event.target))) {
            
            // If it's expanded, minimize it first (which also hides it via the logic above)
            if (!floatingMenu.classList.contains('minimized')) {
                 internalToggleBtn.click();
            } else {
                // If already minimized but still 'visible', just remove 'visible'
                floatingMenu.classList.remove('visible');
            }
        }
    }, true); // Use capture phase

    console.log("Search menu interactions set up.");
}



function handleSearch() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (searchTerm.length < 2) { // Only search if term is 2+ chars
                return;
            }

            const filteredModules = searchableItems.filter(item =>
                item.type === 'module' && item.title.toLowerCase().includes(searchTerm)
            );

            const filteredVideos = searchableItems.filter(item =>
                item.type === 'video' &&
                (item.title.toLowerCase().includes(searchTerm) || (item.description && item.description.toLowerCase().includes(searchTerm)))
            );

            if (filteredModules.length > 0) {
                const moduleLabel = document.createElement('div');
                moduleLabel.className = 'suggestion-category-label';
                moduleLabel.textContent = 'Learning Modules';
                resultsContainer.appendChild(moduleLabel);

                filteredModules.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.innerHTML = `<i class="fas ${item.icon} module-icon"></i> <span>${item.title}</span>`;
                    div.onclick = () => {
                        document.getElementById(item.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        resultsContainer.innerHTML = ''; // Clear results after click
                        document.getElementById('searchInput').value = ''; // Clear search input
                    };
                    resultsContainer.appendChild(div);
                });
            }

            if (filteredVideos.length > 0) {
                 const videoLabel = document.createElement('div');
                videoLabel.className = 'suggestion-category-label';
                videoLabel.textContent = 'Videos';
                resultsContainer.appendChild(videoLabel);

                filteredVideos.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    // Highlight search term in title - basic implementation
                    let displayTitle = item.title;
                    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                    displayTitle = displayTitle.replace(regex, '<mark>$1</mark>');

                    div.innerHTML = `<i class="fas ${item.icon} video-icon-search"></i> <span title="${item.description || ''}">${displayTitle}</span>`;
                    div.onclick = () => {
                        document.getElementById(item.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        resultsContainer.innerHTML = '';
                        document.getElementById('searchInput').value = '';
                    };
                    resultsContainer.appendChild(div);
                });
            }
             if (filteredModules.length === 0 && filteredVideos.length === 0) {
                resultsContainer.innerHTML = '<div class="suggestion-item" style="justify-content:center;">No results found.</div>';
            }
        }

        document.addEventListener('DOMContentLoaded', async function() { // Main (and only) DOMContentLoaded listener
    console.log("Initializing Approvideo Learning Hub...");

    try {
        const response = await fetch('/data/learning_modules-catsubcat-tags-featured.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const jsonData = await response.json();
        categoryData = jsonData;
        console.log("Successfully loaded categoryData from JSON file:", categoryData.length, "items");

        if (!categoryData || categoryData.length === 0) {
            console.error("Fetched JSON data is empty or invalid. Halting further app initialization.");
            document.body.innerHTML = "<p style='color:red; text-align:center; padding:20px;'>Error: Essential content could not be loaded. The data file might be empty or corrupted.</p>";
            return;
        }
    } catch (error) {
        console.error("CRITICAL ERROR: Failed to load and parse category data from JSON file:", error);
        document.body.innerHTML = "<p style='color:red; text-align:center; padding:20px;'>Error: Could not load essential page content. Please check the console for details and try again later.</p>";
        return;
    }

    console.log("Proceeding with page initialization using fetched categoryData.");

    // 1. Initialize Core Data Structures
    flattenVideoData(categoryData);     // Populates global 'allVideosFlat'
    if (typeof buildSearchableItems === 'function') {
        buildSearchableItems(categoryData); // Populates global 'searchableItems'
    } else {
        console.error("CRITICAL: buildSearchableItems function is NOT defined.");
    }

    // 2. Prepare Data for and Populate Area Navigation Icons (for header and search menu)
    const categoryAreasForNav = categoryData.map(cat => ({
        name: cat.area,
        slug: cat.area ? cat.area.toLowerCase().replace(/\s+/g, '-') : `unknown-area-${Date.now()}`,
        svgString: cat.svgString,
        icon: cat.icon 
    }));

    if (typeof populateAreaNavIcons === 'function') {
        populateAreaNavIcons(categoryAreasForNav);
    } else {
        console.error("CRITICAL: populateAreaNavIcons function is NOT defined.");
    }

    // 3. Initialize UI Components & Main Interactions
    generateHomepageModules();           // Renders homepage category cards
    populateSubcategoryPills(categoryData); // Renders subcategory filter pills

    if (typeof setupSearchMenuInteractions === 'function') {
        setupSearchMenuInteractions();   // Handles floating search menu open/close logic
    } else {
        console.error("CRITICAL: setupSearchMenuInteractions function is NOT defined.");
    }
    
    if (typeof setupEventListeners === 'function') { // This function should now include search input listeners
        setupEventListeners();           
    } else {
        console.error("CRITICAL: setupEventListeners function is NOT defined.");
    }
    
    setupHashNavigation();               // Handles URL hash changes for navigation
    initializeSlideshows();              // Sets up any slideshows on the page
    
    // Call to function that renders main page sections (if different from generateHomepageModules)
    // Ensure this function exists and creates elements with IDs if search results need to scroll to them.
    if (typeof createLearningAreasAccordion === 'function') { 
        createLearningAreasAccordion();
    } else {
        // If you don't have/need createLearningAreasAccordion, you can remove this.
        // Or if its functionality is now part of generateHomepageModules, that's also fine.
        console.warn("createLearningAreasAccordion function is not defined (optional).");
    }

    console.log("Approvideo Learning Hub initialized successfully.");
});



// --- Event Delegation Setup ---
// Make sure these DOM element variables are defined in the global scope
// or are accessible to this function. Based on your provided code, they are:
// const categoryContentContainer = document.getElementById('category-content-container');
// const backToModulesButton = document.getElementById('back-to-modules-button');
// const videoInfoPanel = document.getElementById('video-info-panel');
// let allVideosFlat = []; // Populated by flattenVideoData

// --- Event Delegation Setup ---
function setupEventListeners() {
    console.log("Setting up event listeners...");

    // --- Listeners for Category Content Area ---
    if (categoryContentContainer) {
        categoryContentContainer.addEventListener('click', function(event) {
            const target = event.target;

            // Glossary Triggers
            if (target.classList.contains('glossary-trigger')) {
                if (typeof handleGlossaryTriggerClick === 'function') {
                    handleGlossaryTriggerClick(event);
                } else { console.warn("handleGlossaryTriggerClick function not defined."); }
            }
            // Subcategory Toggles (in megamenu columns)
            else if (target.classList.contains('subcategory-toggle')) {
                if (typeof handleSubcategoryToggle === 'function') {
                    handleSubcategoryToggle(event);
                } else { console.warn("handleSubcategoryToggle function not defined."); }
            }
            // Back button within subcategory details view
            else if (target.closest('.details-back-button')) {
                event.preventDefault();
                if (typeof hideSubcategoryDetails === 'function') {
                    hideSubcategoryDetails(true);
                } else { console.warn("hideSubcategoryDetails function not defined."); }
            }
            // Sibling subcategory navigation pills within details view
            else if (target.classList.contains('sibling-link-pill') && !target.classList.contains('current')) {
                event.preventDefault();
                const area = target.dataset.area;
                const uniqueId = target.dataset.uniqueid;
                if (area && uniqueId) {
                    if (typeof displaySubcategoryDetails === 'function') {
                        displaySubcategoryDetails(area, uniqueId, true);
                        requestAnimationFrame(() => {
                            setTimeout(() => {
                                if (megamenuDetailsArea) {
                                    megamenuDetailsArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                }
                            }, 50);
                        });
                    } else { console.warn("displaySubcategoryDetails function not defined."); }
                }
            }
        });
    } else {
        console.warn("#category-content-container not found for event delegation.");
    }

    // --- Back to Modules Button (main back button) ---
    if (backToModulesButton) {
        backToModulesButton.addEventListener('click', () => {
            if (typeof showHomepageView === 'function') {
                showHomepageView();
            } else { console.warn("showHomepageView function not defined."); }
        });
    } else {
        console.warn("#back-to-modules-button not found.");
    }

    // --- Video Hover Info Panel Listeners ---
    // These listeners are on document.body, so they are always active if functions exist.
    if (typeof showInfoPanel === 'function' && typeof hideInfoPanel === 'function' && allVideosFlat) {
        document.body.addEventListener('mouseover', (event) => {
            const linker = event.target.closest('.video-linker');
            if (linker) {
                const flatIndex = linker.getAttribute('data-flat-index');
                if (flatIndex !== null && flatIndex < allVideosFlat.length) {
                    const video = allVideosFlat[parseInt(flatIndex, 10)];
                    if (video) { showInfoPanel(video); }
                    else { console.warn("Video data not found for index:", flatIndex); }
                } else if (flatIndex !== null) {
                    console.warn("Invalid flat_index for video:", flatIndex);
                }
            }
        });

        document.body.addEventListener('mouseout', (event) => {
            const leavingLinker = event.target.closest('.video-linker');
            const enteringElement = event.relatedTarget;
            // Hide only if mouse leaves a video linker AND does not enter another linker or the panel itself
            if (leavingLinker && (!enteringElement || !enteringElement.closest('.video-linker, #video-info-panel'))) {
                setTimeout(() => {
                    // Double check nothing relevant is hovered before hiding
                    const currentlyHovered = document.querySelector('.video-linker:hover, #video-info-panel:hover');
                    if (!currentlyHovered) { hideInfoPanel(); }
                }, 50); // Small delay to handle quick mouse movements between elements
            }
        });

        if (videoInfoPanel) {
            videoInfoPanel.addEventListener('mouseleave', () => {
                // If mouse leaves the panel itself, hide it
                // (This handles the case where mouse moves from linker to panel, then out of panel)
                hideInfoPanel();
            });
        } else {
            console.warn("#video-info-panel not found for mouseleave listener.");
        }
    } else {
        console.warn("Video info panel functions or allVideosFlat data not fully available for hover listeners.");
    }

    // --- Search Input Listener (for autocomplete) ---
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        if (typeof debounce === 'function' && typeof handleSearch === 'function') {
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            console.log("Search input listener attached.");
        } else {
            console.warn("debounce or handleSearch function not defined. Search input will not work.");
        }
    } else {
        console.warn("#searchInput element not found for event listener setup.");
    }

    console.log("Event listeners setup complete.");
}



// Set up hash navigation
function setupHashNavigation() {
    // Handle browser back/forward buttons and direct links
    window.addEventListener('hashchange', handleHashChange);
    
    // Process initial hash on page load
    handleHashChange();
}




     
    </script>
    
</body>
</html>
