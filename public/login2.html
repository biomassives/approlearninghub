<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n="page_title">Sign Up / Login - ApproVideo Hub</title>
  <link rel="stylesheet" href="style.css">
  <meta name="description" content="Login or Create an account on ApproVideo Hub - Sustainable Solutions Platform">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">

 <style>
    /* Inline styles; move to external CSS in production */
    body { font-family: sans-serif; background-color: #f0f4f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
    .hidden { display: none !important; }
    .auth-card { background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 450px; margin-top: 20px; }
    .auth-card h1 { text-align: center; margin-bottom: 25px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
    .button-primary { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; }
    .button-primary:disabled { opacity: 0.6; cursor: not-allowed; }
    .alternate-action { text-align: center; margin-top: 20px; }
    .alternate-action a { color: #007bff; text-decoration: none; cursor: pointer; }
    .alternate-action a:hover { text-decoration: underline; }
    .error-message { color: #d9534f; margin-top: 5px; font-size: 0.9em; }
    .status-box { margin-top: 15px; font-size: 0.95em; }
    .page-header { display: flex; justify-content: space-between; width: 100%; max-width: 1000px; margin-bottom: 20px; align-items: center; }
    .brand-name { font-size: 1.5em; font-weight: bold; }
    .header-controls { font-size: 0.9em; }
    .page-footer { margin-top: auto; padding-top: 30px; font-size: 0.8em; color: #666; text-align: center; }
    .page-footer a { color: #666; }
  </style>
</head>
<body>
  <header class="page-header">
    <div class="brand-name" data-i18n="brand_name">ApproVideo Hub</div>
    <div class="header-controls" data-i18n="secure_connection">Secure Connection</div>
  </header>

  <main class="auth-container" role="main">
    <!-- Signup Card -->
    <div id="signup-section" class="auth-card">
      <h1 data-i18n="signup_title">Create Account</h1>
      <form id="signup-form" novalidate>
        <div class="form-group">
          <label for="signup-email" data-i18n="email_label">Email Address</label>
          <input type="email" id="signup-email" name="email" required autocomplete="email" placeholder="your.email@example.com">
          <p aria-live="polite" class="error-message" id="signup-email-error"></p>
        </div>
        <div class="form-group">
          <label for="signup-password" data-i18n="password_label">Password</label>
          <input type="password" id="signup-password" name="password" required minlength="6" autocomplete="new-password">
          <p aria-live="polite" class="error-message" id="signup-password-error"></p>
        </div>
        <div class="form-group">
          <label for="signup-confirm-password" data-i18n="confirm_password_label">Confirm Password</label>
          <input type="password" id="signup-confirm-password" name="confirm-password" required minlength="6" autocomplete="new-password">
          <p aria-live="polite" class="error-message" id="signup-confirm-password-error"></p>
        </div>
        <div class="form-group">
          <label for="signup-role" data-i18n="role_label">Select Your Role</label>
          <select id="signup-role" name="role" required>
            <option value="" disabled selected data-i18n="role_placeholder">-- Select a Role --</option>
            <option value="expert" data-i18n="role_expert">Expert / Workshop Leader</option>
            <option value="learner" data-i18n="role_learner">Learner / Volunteer</option>
            <option value="researcher" data-i18n="role_researcher">Research Contributor</option>
            <option value="resources" data-i18n="role_resources">Resource Finder</option>
            <option value="organizer" data-i18n="role_organizer">Organizer / Coordinator</option>
          </select>
          <p aria-live="polite" class="error-message" id="signup-role-error"></p>
        </div>
        <div class="form-group form-group-checkbox">
          <input type="checkbox" id="signup-terms" name="terms" required>
          <label for="signup-terms" data-i18n="terms_label">I agree to the Terms of Service and Privacy Policy</label>
          <p aria-live="polite" class="error-message" id="signup-terms-error"></p>
        </div>
        <div class="form-group">
          <button type="submit" class="button-primary" id="signup-button" data-i18n="signup_button">Create Account</button>
        </div>
        <div aria-live="polite" class="status-box" id="signup-status-area"></div>
      </form>
      <div class="alternate-action">
        <span data-i18n="already_account_prefix">Already have an account?</span>
        <a id="show-login-link" data-i18n="login_link" href="#">Log in</a>
      </div>
    </div>

    <!-- Login Card -->
    <div id="login-section" class="auth-card hidden">
      <h1 data-i18n="login_title">Login</h1>
      <form id="login-form" novalidate>
        <div class="form-group">
          <label for="login-email" data-i18n="email_label">Email Address</label>
          <input type="email" id="login-email" name="email" required autocomplete="email">
          <p aria-live="polite" class="error-message" id="login-email-error"></p>
        </div>
        <div class="form-group">
          <label for="login-password" data-i18n="password_label">Password</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password">
          <p aria-live="polite" class="error-message" id="login-password-error"></p>
        </div>
        <div class="form-group">
          <button type="submit" class="button-primary" id="login-button" data-i18n="login_button">Log In</button>
        </div>
        <div aria-live="polite" class="status-box" id="login-status-area"></div>
      </form>
      <div class="alternate-action">
        <span data-i18n="need_account_prefix">Need an account?</span>
        <a id="show-signup-link" data-i18n="signup_link" href="#">Sign up</a>
      </div>
    </div>
  </main>

  <footer class="page-footer">
    <p><a href="/privacy.html" target="_blank" data-i18n="privacy_policy">Privacy Policy</a> | <a href="/terms.html" target="_blank" data-i18n="terms_of_service">Terms of Service</a></p>
  </footer>

  <script type="module">
    import authService from './js/auth-service.js';
    import { applyTranslations, initLanguageSwitcher } from './js/i18n.js';

    document.addEventListener('DOMContentLoaded', async () => {
  // Clear any redirect flags that might cause loops
  if (sessionStorage.getItem('last_redirect')) {
    const lastRedirect = parseInt(sessionStorage.getItem('last_redirect'));
    const now = Date.now();
    
    // If last redirect was more than 30 seconds ago, clear it
    // This prevents redirect loops that might have been caused by stale flags
    if (now - lastRedirect > 30000) {
      console.log('Clearing stale redirect flags');
      sessionStorage.removeItem('last_redirect');
    }
  }
  
  // Initialize translations
  try {
    initLanguageSwitcher();
    await applyTranslations({ '[data-i18n]': el => el.getAttribute('data-i18n') });
  } catch (err) {
    console.error('i18n init error:', err);
  }

  // Always hit our API prefix
  authService.apiBase = '/api/auth';

  const DASHBOARD_ROUTES = {
    expert: '/expert-dashboard.html',
    learner: '/learner-dashboard.html',
    researcher: '/researcher-dashboard.html',
    resources: '/resources-dashboard.html',
    organizer: '/organizer-dashboard.html'
  };
  
  // Safer redirect function to prevent loops
  const redirectToDashboard = role => {
    const dashboardUrl = DASHBOARD_ROUTES[role] || '/dashboard.html';
    
    // Set redirect flag
    sessionStorage.setItem('last_redirect', Date.now().toString());
    
    console.log(`Redirecting to ${dashboardUrl} with role ${role}`);
    window.location.href = dashboardUrl;
  };

  // Cache elements
  const signupForm    = document.getElementById('signup-form');
  const signupButton  = document.getElementById('signup-button');
  const loginForm     = document.getElementById('login-form');
  const loginButton   = document.getElementById('login-button');
  const signupSection = document.getElementById('signup-section');
  const loginSection  = document.getElementById('login-section');
  const showLoginLink = document.getElementById('show-login-link');
  const showSignupLink= document.getElementById('show-signup-link');

  // Toggle forms
  if (showLoginLink && signupSection && loginSection) {
    showLoginLink.addEventListener('click', e => { e.preventDefault(); signupSection.classList.add('hidden'); loginSection.classList.remove('hidden'); });
  }
  if (showSignupLink && signupSection && loginSection) {
    showSignupLink.addEventListener('click', e => { e.preventDefault(); loginSection.classList.add('hidden'); signupSection.classList.remove('hidden'); });
  }

  // Disable double-submit wrapper
  const disableDuring = (btn, fn) => async e => { btn.disabled = true; try { await fn(e); } finally { btn.disabled = false; } };

  // Signup handler
  signupForm.addEventListener('submit', disableDuring(signupButton, async e => {
    e.preventDefault();
    // Clear errors
    ['email','password','confirm-password','role','terms'].forEach(f => { document.getElementById(`signup-${f}-error`).textContent = ''; });
    document.getElementById('signup-status-area').textContent = '';

    // Collect
    const email    = signupForm['email'].value.trim();
    const password = signupForm['password'].value;
    const confirm  = signupForm['confirm-password'].value;
    const role     = signupForm['role'].value;
    const terms    = signupForm['terms'].checked;

    // Client-side validation
    let valid = true;
    if (!email || !/.+@.+\..+/.test(email)) {
      document.getElementById('signup-email-error').textContent = window.T('email_invalid'); valid = false;
    }
    if (password.length < 6) {
      document.getElementById('signup-password-error').textContent = window.T('password_too_short'); valid = false;
    }
    if (password !== confirm) {
      document.getElementById('signup-confirm-password-error').textContent = window.T('confirm_password_mismatch'); valid = false;
    }
    if (!role) {
      document.getElementById('signup-role-error').textContent = window.T('role_required'); valid = false;
    }
    if (!terms) {
      document.getElementById('signup-terms-error').textContent = window.T('terms_required'); valid = false;
    }
    if (!valid) return;

    try {
      // Call the signup method
      const response = await authService.signup(email, password, role);
      if (response.success) {
        document.getElementById('signup-status-area').textContent = window.T('signup_success');
        
        // Store redirect info in sessionStorage with better timeout handling
        sessionStorage.setItem('signup_success', 'true');
        sessionStorage.setItem('last_auth_action', Date.now().toString());
        sessionStorage.setItem('user_role', role);
        
        // Important: Use setTimeout to delay redirect and avoid loops
        setTimeout(() => {
          // Clear potential loop flags
          sessionStorage.removeItem('last_redirect');
          
          // Build the redirect URL
          const dashboardRoutes = {
            expert: '/expert-dashboard.html',
            learner: '/learner-dashboard.html',
            researcher: '/researcher-dashboard.html',
            resources: '/resources-dashboard.html',
            organizer: '/organizer-dashboard.html'
          };
          
          const redirectUrl = dashboardRoutes[role] || '/dashboard.html';
          console.log(`Redirecting to ${redirectUrl} with role ${role} after signup`);
          
          // Set new redirect flag and redirect
          sessionStorage.setItem('last_redirect', Date.now().toString());
          window.location.href = redirectUrl;
        }, 2000); // 2 second delay to allow message to show and prevent redirect loops
        
      } else {
        document.getElementById('signup-status-area').textContent = response.error || window.T('signup_failed');
      }
    } catch (err) {
      console.error('Signup exception:', err);
      document.getElementById('signup-status-area').textContent = window.T('unexpected_error');
    }
  }));

  // Login handler
  loginForm.addEventListener('submit', disableDuring(loginButton, async e => {
    e.preventDefault();
    ['email','password'].forEach(f => { document.getElementById(`login-${f}-error`).textContent = ''; });
    document.getElementById('login-status-area').textContent = '';

    const email    = loginForm['email'].value.trim();
    const password = loginForm['password'].value;
    if (!email || !password) {
      document.getElementById('login-status-area').textContent = window.T('login_failed'); return;
    }

    try {
      const response = await authService.login(email, password);
      if (response.success) {
        document.getElementById('login-status-area').textContent = window.T('login_success');
        
        // Clear any existing redirect flags
        sessionStorage.removeItem('last_redirect');
        
        // Set new redirect and redirect after delay
        setTimeout(() => {
          sessionStorage.setItem('last_redirect', Date.now().toString());
          redirectToDashboard(response.user.role);
        }, 500);
      } else {
        document.getElementById('login-status-area').textContent = response.error || window.T('login_failed');
      }
    } catch (err) {
      console.error('Login exception:', err);
      document.getElementById('login-status-area').textContent = window.T('unexpected_error');
    }
  }));
});
  </script>
</body>
</html>
