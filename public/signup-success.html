<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Verification - ApproVideo Hub</title>
  <link rel="stylesheet" href="./css/main.css">
  <meta name="description" content="Verify your email to complete your ApproVideo Hub account setup">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen">
  <!-- Header with branding -->
  <header class="absolute top-4 left-4 flex items-center space-x-2 text-green-700 font-semibold text-lg">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </svg>
    <span>ApproVideo Hub</span>
  </header>

  <!-- Language selector -->
  <div class="absolute top-4 right-4">
    <label for="lang-switch" class="text-sm text-gray-600 mr-2">Language:</label>
    <select id="lang-switch" class="text-sm border rounded p-1">
      <option value="en">ðŸ‡¬ðŸ‡§ English</option>
      <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
      <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
      <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
      <option value="zh">ðŸ‡¨ðŸ‡³ ä¸­æ–‡</option>
      <option value="ar">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>
  </div>
  
  <!-- Main content card -->
  <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-md transition-all text-center">
    <!-- Success icon -->
    <div class="mb-6 flex justify-center">
      <div class="rounded-full bg-green-100 p-3">
        <svg class="w-16 h-16 text-green-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
          <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
      </div>
    </div>
    
    <h1 class="text-2xl font-bold mb-4 text-gray-800" id="page-title">Check Your Email</h1>
    
    <p class="text-gray-600 mb-6" id="main-message">
      We've sent a confirmation link to your email address.<br>
      Please check your inbox and click the link to verify your account.
    </p>
    
    <!-- Info box -->
    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-8 text-left rounded">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <p class="text-sm text-blue-700" id="important-note">
            <span class="font-medium">Important:</span> If you don't see the email, please check your spam folder.
            The email should arrive within a few minutes.
          </p>
        </div>
      </div>
    </div>
    
    <!-- Timer countdown -->
    <div class="mb-6">
      <p class="text-sm text-gray-600" id="resend-message">You can request a new verification email in</p>
      <p class="text-xl font-bold text-indigo-600"><span id="countdown-timer">02:00</span></p>
    </div>
    
    <!-- Action buttons -->
    <div class="flex flex-col space-y-3 sm:flex-row sm:space-y-0 sm:space-x-3 sm:justify-between">
      <a href="login.html" class="px-4 py-2 bg-white border border-gray-300 rounded-md font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors text-center" id="back-to-login">
        Back to Login
      </a>
      <button id="resend-btn" disabled class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors opacity-50 cursor-not-allowed">
        Resend Email
      </button>
      <a href="signup.html" class="text-indigo-600 hover:text-indigo-500 font-medium hidden sm:inline-flex items-center">
        <span id="change-email">Change Email</span>
        <svg class="ml-1 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
        </svg>
      </a>
    </div>
    
    <!-- Mobile link for small screens -->
    <div class="mt-4 sm:hidden">
      <a href="signup.html" class="text-indigo-600 hover:text-indigo-500 font-medium">
        <span id="mobile-change-email">Change Email</span>
      </a>
    </div>
    
    <!-- Help text -->
    <div class="mt-8 text-sm text-gray-500">
      <p id="help-text">Need help? <a href="mailto:support@approvideo.org" class="text-indigo-600 hover:text-indigo-500">Contact Support</a></p>
    </div>
  </div>

  <!-- Security & terms footer -->
  <footer class="mt-8 mb-4 text-center text-xs text-gray-500">
    <p>Protected by ApproVideo Hub's Lattice Security System</p>
    <p class="mt-1">
      <a href="/privacy.html" class="hover:underline">Privacy Policy</a> &middot; 
      <a href="/terms.html" class="hover:underline">Terms of Service</a>
    </p>
  </footer>

  <!-- Import translations module -->
  <script type="module" src="./js/translations.js"></script>
  
  <script type="module">
    import { setupTranslations, T } from './js/translations.js';
    
    // Elements
    const countdownTimer = document.getElementById('countdown-timer');
    const resendBtn = document.getElementById('resend-btn');
    const langSwitcher = document.getElementById('lang-switch');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', initPage);
    
    /**
     * Initialize the page
     */
    async function initPage() {
      // Set up translations
      await setupTranslations();
      
      // Apply translations
      applyTranslations();
      
      // Get email from URL if available
      const urlParams = new URLSearchParams(window.location.search);
      const email = urlParams.get('email');
      
      // Store email in session storage
      if (email) {
        sessionStorage.setItem('verification_email', email);
      }
      
      // Start countdown timer
      startCountdown();
      
      // Set up language switcher
      langSwitcher.addEventListener('change', handleLanguageChange);
      
      // Set up resend button
      resendBtn.addEventListener('click', handleResend);
      
      // Set up language switcher value
      const queryLang = urlParams.get('lang');
      const browserLang = navigator.language.slice(0, 2);
      const savedLang = localStorage.getItem('preferredLang');
      const lang = queryLang || savedLang || browserLang;
      
      langSwitcher.value = lang;
    }
    
    /**
     * Apply translations to the page
     */
    function applyTranslations() {
      document.getElementById('page-title').textContent = T('check_email_title', 'Check Your Email');
      document.getElementById('main-message').innerHTML = T('verification_message', "We've sent a confirmation link to your email address.<br>Please check your inbox and click the link to verify your account.");
      document.getElementById('important-note').innerHTML = T('important_note', '<span class="font-medium">Important:</span> If you don\'t see the email, please check your spam folder. The email should arrive within a few minutes.');
      document.getElementById('resend-message').textContent = T('resend_countdown', 'You can request a new verification email in');
      document.getElementById('back-to-login').textContent = T('back_to_login', 'Back to Login');
      resendBtn.textContent = T('resend_email', 'Resend Email');
      document.getElementById('change-email').textContent = T('change_email', 'Change Email');
      document.getElementById('mobile-change-email').textContent = T('change_email', 'Change Email');
      document.getElementById('help-text').innerHTML = T('need_help', 'Need help? <a href="mailto:support@approvideo.org" class="text-indigo-600 hover:text-indigo-500">Contact Support</a>');
    }
    
    /**
     * Start countdown timer
     */
    function startCountdown() {
      let minutes = 2;
      let seconds = 0;
      
      // Check if there's a stored countdown time
      const storedEndTime = localStorage.getItem('resend_countdown_end');
      if (storedEndTime) {
        const endTime = parseInt(storedEndTime, 10);
        const currentTime = new Date().getTime();
        const timeLeft = Math.max(0, endTime - currentTime);
        
        if (timeLeft > 0) {
          // Calculate minutes and seconds from time left
          minutes = Math.floor(timeLeft / 60000);
          seconds = Math.floor((timeLeft % 60000) / 1000);
        } else {
          // Countdown already finished
          enableResendButton();
          return;
        }
      } else {
        // Set the end time for the countdown
        const endTime = new Date().getTime() + (minutes * 60 + seconds) * 1000;
        localStorage.setItem('resend_countdown_end', endTime.toString());
      }
      
      // Update timer every second
      const timer = setInterval(() => {
        if (seconds > 0) {
          seconds--;
        } else if (minutes > 0) {
          minutes--;
          seconds = 59;
        } else {
          // Countdown finished
          clearInterval(timer);
          enableResendButton();
          return;
        }
        
        // Update display
        countdownTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }
    
    /**
     * Enable resend button when countdown completes
     */
    function enableResendButton() {
      countdownTimer.textContent = '00:00';
      resendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      resendBtn.disabled = false;
      
      // Update text
      document.getElementById('resend-message').textContent = T('resend_ready', 'You can now request a new verification email');
    }
    
    /**
     * Handle resend button click
     */
    async function handleResend() {
      // Show loading state
      resendBtn.disabled = true;
      resendBtn.textContent = T('sending', 'Sending...');
      
      try {
        // Get email from session storage
        const email = sessionStorage.getItem('verification_email');
        
        if (!email) {
          // Redirect to signup if no email is stored
          window.location.href = 'signup.html';
          return;
        }
        
        // Make API request to resend verification
        const response = await fetch('/api/auth/resend-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        
        if (response.ok) {
          // Reset countdown
          localStorage.removeItem('resend_countdown_end');
          
          // Show success message
          resendBtn.textContent = T('email_sent', 'Email Sent!');
          resendBtn.classList.add('bg-green-600', 'hover:bg-green-700');
          
          // Reset after 3 seconds
          setTimeout(() => {
            resendBtn.textContent = T('resend_email', 'Resend Email');
            resendBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            resendBtn.classList.add('opacity-50', 'cursor-not-allowed');
            resendBtn.disabled = true;
            startCountdown();
          }, 3000);
        } else {
          // Show error
          const result = await response.json();
          resendBtn.textContent = result.error || T('resend_failed', 'Failed to resend');
          resendBtn.classList.add('bg-red-600', 'hover:bg-red-700');
          
          // Reset after 3 seconds
          setTimeout(() => {
            resendBtn.textContent = T('resend_email', 'Resend Email');
            resendBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            resendBtn.disabled = false;
          }, 3000);
        }
      } catch (error) {
        console.error('Error resending verification:', error);
        
        // Show error
        resendBtn.textContent = T('resend_failed', 'Failed to resend');
        resendBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        
        // Reset after 3 seconds
        setTimeout(() => {
          resendBtn.textContent = T('resend_email', 'Resend Email');
          resendBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
          resendBtn.disabled = false;
        }, 3000);
      }
    }
    
    /**
     * Handle language change
     */
    function handleLanguageChange(e) {
      const selectedLang = e.target.value;
      localStorage.setItem('preferredLang', selectedLang);
      
      // Reload the page with language parameter
      const url = new URL(window.location.href);
      url.searchParams.set('lang', selectedLang);
      window.location.href = url.toString();
    }
  </script>
</body>
</html>