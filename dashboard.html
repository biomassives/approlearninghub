<!DOCTYPE html>
<html lang="en" data-translate-title-key="DASHBOARD_TITLE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Approvideo Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="dashboard.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
    <!-- Banner Message -->
    <div class="banner-message bg-gradient-to-r from-green-600 to-blue-600 text-white py-2 px-4 text-center text-sm transition-opacity duration-300 ease-in-out">
        Welcome to your Approvideo Learning Hub Dashboard
    </div>

    <!-- Header Section -->
    <header class="shadow-lg">
        <div class="container mx-auto">
            <nav class="shadow-lg rounded-lg mb-8 transition-colors duration-300 bg-white dark:bg-gray-800" id="mainNav">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <!-- Logo and Brand -->
                        <div class="flex items-center space-x-4">
                            <a href="index.html" class="flex items-center space-x-3 group">
                                <svg id="logoIcon" class="h-10 w-10 text-green-500 group-hover:text-green-600 transition-colors duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l-4.655 4.654A3.375 3.375 0 0 1 2.135 15.17l4.654-4.655M11.42 15.17l-1.518-.506a5.25 5.25 0 0 1-4.474-4.474l-.506-1.518M11.42 15.17 15.88 10.71m0 0A5.25 5.25 0 0 1 10.71 15.88m5.17-5.17A5.25 5.25 0 0 0 10.71 5.17m5.17 5.17 5.877 5.877a2.652 2.652 0 0 0 3.75-3.75L15.88 10.71Z" />
                                </svg>
                                <span class="text-xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                    Approvideo Learning Hub
                                </span>
                            </a>
                        </div>
                        
                        <!-- Navigation Items -->
                        <div class="flex items-center space-x-6">
                            <!-- Offline Indicator -->
                            <span id="offline-indicator" class="text-xs ml-2 font-semibold text-yellow-600 dark:text-yellow-400"></span>
                            
                            <!-- Website Link -->
                            <a href="/" class="nav-link group" data-translate-title="NAV_LINK_WEBSITE_TITLE">
                                <svg class="w-6 h-6 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9.004 9.004 0 0 0 8.716-6.747M12 21a9.004 9.004 0 0 1-8.716-6.747M12 21c.246 0 .492-.015.732-.044m-1.464 0A9.006 9.006 0 0 1 12 3c.587 0 1.159.069 1.711.193M12 3a9.006 9.006 0 0 0-7.08 2.886M12 3c.015-.01.03-.019.046-.028M12 12a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm4.016 4.016a9.003 9.003 0 0 0 -8.032 0M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z" />
                                </svg>
                            </a>
                            
                            <!-- New Content Link -->
                            <a href="new.html" class="nav-link group" data-translate-title="NAV_LINK_NEW_TITLE">
                                <svg class="w-6 h-6 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                                </svg>
                            </a>
                            
                            <!-- Dark Mode Toggle -->
                            <a href="#" id="darkModeToggle" class="nav-link group" data-translate-title="TOGGLE_DARK_MODE_TITLE">
                                <svg class="w-6 h-6 text-gray-800 dark:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                                </svg>
                            </a>
                            
                            <!-- Language Dropdown -->
                            <div id="lang-dropdown" class="relative">
                                <!-- Current language button -->
                                <button id="lang-toggle" class="flex items-center space-x-1 bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md border border-gray-600 transition duration-150">
                                    <span id="current-lang">EN</span>
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>
                                
                                <!-- Dropdown panel -->
                                <div id="lang-panel" class="absolute right-0 mt-2 bg-gray-800 rounded-md shadow-lg z-50 border border-gray-700 hidden">
                                    <div class="p-3">
                                        <!-- Language grid container -->
                                        <div id="lang-switcher" class="grid gap-2 max-h-[60vh] overflow-y-auto">
                                            <button data-lang="am" class="lang-button bg-gray-700 hover:bg-gray-600 text-white p-1.5 text-xs font-medium rounded border border-gray-600 transition duration-150">AM</button>
                                            <button data-lang="ar" class="lang-button bg-gray-700 hover:bg-gray-600 text-white p-1.5 text-xs font-medium rounded border border-gray-600 transition duration-150">AR</button>
                                            <!-- More language buttons -->
                                            <button data-lang="en" class="lang-button bg-gray-700 hover:bg-gray-600 text-white p-1.5 text-xs font-medium rounded border border-gray-600 transition duration-150">EN</button>
                                            <button data-lang="es" class="lang-button bg-gray-700 hover:bg-gray-600 text-white p-1.5 text-xs font-medium rounded border border-gray-600 transition duration-150">ES</button>
                                            <!-- More language buttons would be here -->
                                        </div>
                                        
                                        <!-- Translation help button -->
                                        <a href="https://github.com/yourusername/your-repo/tree/main/languages" class="bg-green-600 hover:bg-green-500 text-white p-2 text-xs font-medium rounded flex items-center justify-center mt-3 border border-green-500 transition duration-150">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                            </svg>
                                            Help Translate
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Profile Dropdown -->
                            <div class="relative">
                                <button id="profileButton" class="flex items-center text-gray-700 dark:text-gray-300 hover:text-green-600 dark:hover:text-green-400" data-translate-title="PROFILE_MENU_TITLE">
                                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0A8.966 8.966 0 0112 21a8.966 8.966 0 01-5.982-2.275M15 9.75a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                                <div id="profileDropdown" class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg z-50 hidden">
                                    <div class="py-1">
                                        <a href="https://content.approvideo.org" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-translate-key="DROPDOWN_APPROVIDEO_BETA">Approvideo beta</a>
                                        <a href="pending.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-translate-key="DROPDOWN_PENDING">Pending</a>
                                        <a href="admin/taxonomy0.html" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-translate-key="DROPDOWN_TAXONOMY">Taxonomy</a>
                                        <a href="#" id="signOutButton" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700" data-translate-key="DROPDOWN_SIGN_OUT">Sign out</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Dashboard Header -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg mb-8 p-6 border-l-4 border-green-500">
            <h1 class="text-3xl font-bold mb-2" data-translate-key="DASHBOARD_TITLE">Dashboard</h1>
            <p class="text-gray-600 dark:text-gray-300" data-translate-key="DASHBOARD_DESC">Manage your Approvideo Learning Hub content and activities</p>
        </div>

        <!-- Dashboard Content -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Analytics Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                    </svg>
                    Analytics
                </h2>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Total Videos</span>
                        <span class="font-semibold" id="totalVideos">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Pending Approval</span>
                        <span class="font-semibold" id="pendingVideos">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">User Submissions</span>
                        <span class="font-semibold" id="userSubmissions">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Recent Activity
                </h2>
                <div class="space-y-3" id="recentActivityList">
                    <div class="flex items-start pb-2 border-b border-gray-200 dark:border-gray-700">
                        <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 p-1 rounded text-xs mr-2">NEW</span>
                        <div>
                            <p class="text-sm font-medium">New video was added to Solar category</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">2 hours ago</p>
                        </div>
                    </div>
                    <div class="flex items-start pb-2 border-b border-gray-200 dark:border-gray-700">
                        <span class="bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 p-1 rounded text-xs mr-2">PENDING</span>
                        <div>
                            <p class="text-sm font-medium">New submission awaiting review</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">5 hours ago</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <span class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 p-1 rounded text-xs mr-2">EDIT</span>
                        <div>
                            <p class="text-sm font-medium">Water category was updated</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Yesterday</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                    </svg>
                    Quick Actions
                </h2>
                <div class="grid grid-cols-1 gap-3">
                    <a href="new.html" class="btn-action bg-gradient-to-r from-green-600 to-blue-600 text-white py-2 px-4 rounded-md flex items-center justify-center hover:from-green-700 hover:to-blue-700 transition">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add New Video
                    </a>
                    <a href="pending.html" class="btn-action bg-yellow-500 text-white py-2 px-4 rounded-md flex items-center justify-center hover:bg-yellow-600 transition">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                        </svg>
                        Review Pending
                    </a>
                    <a href="admin/taxonomy0.html" class="btn-action bg-indigo-500 text-white py-2 px-4 rounded-md flex items-center justify-center hover:bg-indigo-600 transition">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" />
                        </svg>
                        Manage Categories
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Videos Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg mt-8 p-6">
            <h2 class="text-2xl font-bold mb-4">Recent Videos</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Title</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Category</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="recentVideosTable">
                        <!-- Video entries will be loaded dynamically -->
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">DIY Solar Water Heater</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Solar</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Published</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Apr 5, 2025</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div class="flex space-x-2">
                                    <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">Edit</button>
                                    <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                                </div>
                            </td>
                        </tr>
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">Rainwater Harvesting System</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Water</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">Pending</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">Apr 4, 2025</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                <div class="flex space-x-2">
                                    <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">Review</button>
                                    <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Delete</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 text-center">
                <a href="#" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 font-medium">View All Videos â†’</a>
            </div>
        </div>
    </main>

    <!-- Toast Container for Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- JavaScript -->
    <script type="module">
        // Import Supabase
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        // Supabase initialization
        const supabaseUrl = 'https://vlvbodwrtblttvwnxkjx.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZsdmJvZHdydGJsdHR2d254a2p4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2ODY3NDk2NzIsImV4cCI6MjAwMjMyNTY3Mn0.TRT1HeX85vP1zDxnU7qBz5GqNPgYZUj-BOdek4qmtEg';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // Banner messages
      // Banner messages rotation
const bannerMessages = [
    "ðŸŽ¥ Sharing knowledge that changes lives - One Appro Clinic at a time",
    "ðŸŒ± Building resilience through appropriate technology",
    "ðŸ’§ Clean water, safe shelter, better lives",
    "ðŸŒŸ Empowering communities with sustainable solutions",
    "ðŸ¤ Technology that serves humanity"
];

// Function to check auth status
async function checkAuthStatus() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;
        return {
            isAuthenticated: !!session?.user,
            user: session?.user || null
        };
    } catch (error) {
        console.error('Auth check error:', error);
        return { isAuthenticated: false, user: null };
    }
}

// Toast notification function
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;

    const toast = document.createElement('div');
    let bgColorClass = 'bg-blue-600'; // Default for info
    
    if (type === 'success') {
        bgColorClass = 'bg-green-600';
    } else if (type === 'error') {
        bgColorClass = 'bg-red-600';
    } else if (type === 'warning') {
        bgColorClass = 'bg-yellow-600';
    }

    toast.className = `toast-message ${bgColorClass} text-white p-3 rounded-md shadow-lg max-w-sm animate-fadeInOut`;
    toast.textContent = message;

    toastContainer.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3500);
}

// Function to load analytics data
async function loadAnalytics() {
    try {
        // Fetch total videos count
        const { count: totalCount, error: totalError } = await supabase
            .from('videos')
            .select('*', { count: 'exact', head: true });
        
        if (totalError) throw totalError;
        
        // Fetch pending videos count
        const { count: pendingCount, error: pendingError } = await supabase
            .from('videos')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'pending');
        
        if (pendingError) throw pendingError;
        
        // Fetch user submissions count (videos not created by admins)
        const { count: submissionsCount, error: submissionsError } = await supabase
            .from('videos')
            .select('*', { count: 'exact', head: true })
            .not('user_id', 'is', null);
        
        if (submissionsError) throw submissionsError;
        
        // Update UI
        document.getElementById('totalVideos').textContent = totalCount || 0;
        document.getElementById('pendingVideos').textContent = pendingCount || 0;
        document.getElementById('userSubmissions').textContent = submissionsCount || 0;
    } catch (error) {
        console.error('Error loading analytics:', error);
        document.getElementById('totalVideos').textContent = 'Error';
        document.getElementById('pendingVideos').textContent = 'Error';
        document.getElementById('userSubmissions').textContent = 'Error';
        showToast('Failed to load analytics data', 'error');
    }
}

// Function to load recent activity
async function loadRecentActivity() {
    try {
        // Get recent videos (created in the last 30 days)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const { data: recentVideos, error: videosError } = await supabase
            .from('videos')
            .select('id, title, status, created_at, category_id, subcategory_id')
            .gt('created_at', thirtyDaysAgo.toISOString())
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (videosError) throw videosError;
        
        // Get category names for the videos
        const categoryIds = recentVideos
            .map(video => video.category_id)
            .filter(id => id); // Filter out nulls
        
        let categories = [];
        if (categoryIds.length > 0) {
            const { data: categoryData, error: categoryError } = await supabase
                .from('categories')
                .select('id, name')
                .in('id', categoryIds);
            
            if (categoryError) throw categoryError;
            categories = categoryData || [];
        }
        
        // Update recent activity list
        const activityList = document.getElementById('recentActivityList');
        if (!activityList) return;
        
        if (recentVideos.length === 0) {
            activityList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No recent activity</p>';
            return;
        }
        
        activityList.innerHTML = '';
        
        recentVideos.slice(0, 3).forEach(video => {
            const category = categories.find(c => c.id === video.category_id);
            const categoryName = category ? category.name : 'Uncategorized';
            
            const timeAgo = formatTimeAgo(new Date(video.created_at));
            
            let badgeClass = 'bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200';
            let badgeText = 'NEW';
            
            if (video.status === 'pending') {
                badgeClass = 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200';
                badgeText = 'PENDING';
            } else if (video.status === 'published') {
                badgeClass = 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200';
                badgeText = 'PUBLISHED';
            }
            
            const activityHtml = `
                <div class="flex items-start pb-2 border-b border-gray-200 dark:border-gray-700">
                    <span class="${badgeClass} p-1 rounded text-xs mr-2">${badgeText}</span>
                    <div>
                        <p class="text-sm font-medium">${video.title}</p>
                        <p class="text-xs text-gray-500 dark:text-gray-400">${timeAgo} in ${categoryName}</p>
                    </div>
                </div>
            `;
            
            activityList.innerHTML += activityHtml;
        });
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
        const activityList = document.getElementById('recentActivityList');
        if (activityList) {
            activityList.innerHTML = '<p class="text-red-500">Failed to load recent activity</p>';
        }
        showToast('Failed to load recent activity', 'error');
    }
}

// Function to load recent videos for the table
async function loadRecentVideos() {
    try {
        const { data: videos, error } = await supabase
            .from('videos')
            .select(`
                id, 
                title, 
                status, 
                created_at, 
                category_id, 
                subcategory_id
            `)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) throw error;
        
        // Get categories for the videos
        const categoryIds = videos
            .map(video => video.category_id)
            .filter(id => id);
        
        let categories = [];
        if (categoryIds.length > 0) {
            const { data: categoryData, error: categoryError } = await supabase
                .from('categories')
                .select('id, name')
                .in('id', categoryIds);
            
            if (categoryError) throw categoryError;
            categories = categoryData || [];
        }
        
        // Update videos table
        const tableBody = document.getElementById('recentVideosTable');
        if (!tableBody) return;
        
        if (videos.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                        No videos found
                    </td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = '';
        
        videos.forEach(video => {
            const category = categories.find(c => c.id === video.category_id);
            const categoryName = category ? category.name : 'Uncategorized';
            
            const date = new Date(video.created_at);
            const formattedDate = `${date.toLocaleDateString()}`;
            
            let statusBadgeClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
            let statusText = 'Draft';
            
            if (video.status === 'pending') {
                statusBadgeClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                statusText = 'Pending';
            } else if (video.status === 'published') {
                statusBadgeClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                statusText = 'Published';
            }
            
            const rowHtml = `
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${video.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${categoryName}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadgeClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formattedDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        <div class="flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" 
                                    data-video-id="${video.id}" onclick="editVideo('${video.id}')">
                                Edit
                            </button>
                            <button class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                                    data-video-id="${video.id}" onclick="deleteVideo('${video.id}')">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            
            tableBody.innerHTML += rowHtml;
        });
        
    } catch (error) {
        console.error('Error loading recent videos:', error);
        const tableBody = document.getElementById('recentVideosTable');
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-red-500">
                        Failed to load videos. Please try again later.
                    </td>
                </tr>
            `;
        }
        showToast('Failed to load recent videos', 'error');
    }
}

// Helper function to format time ago
function formatTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'just now';
    }
    
    const diffInMinutes = Math.floor(diffInSeconds / 60);
    if (diffInMinutes < 60) {
        return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
    }
    
    const diffInHours = Math.floor(diffInMinutes / 60);
    if (diffInHours < 24) {
        return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
    }
    
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 30) {
        return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
    }
    
    const diffInMonths = Math.floor(diffInDays / 30);
    if (diffInMonths < 12) {
        return `${diffInMonths} month${diffInMonths > 1 ? 's' : ''} ago`;
    }
    
    const diffInYears = Math.floor(diffInMonths / 12);
    return `${diffInYears} year${diffInYears > 1 ? 's' : ''} ago`;
}

// Function to handle banner rotation
function setupBannerRotation() {
    const bannerElement = document.querySelector('.banner-message');
    if (!bannerElement) return;
    
    let currentIndex = 0;
    
    function updateBanner() {
        bannerElement.style.opacity = '0';
        
        setTimeout(() => {
            bannerElement.textContent = bannerMessages[currentIndex];
            bannerElement.style.opacity = '1';
            currentIndex = (currentIndex + 1) % bannerMessages.length;
        }, 300); // Match transition duration
    }
    
    // Set initial message
    updateBanner();
    
    // Rotate messages every 5 seconds
    setInterval(updateBanner, 5000);
}

// Function to handle profile dropdown
function setupProfileDropdown() {
    const profileButton = document.getElementById('profileButton');
    const profileDropdown = document.getElementById('profileDropdown');
    
    if (!profileButton || !profileDropdown) return;
    
    let isDropdownOpen = false;
    
    profileButton.addEventListener('click', (e) => {
        e.stopPropagation();
        isDropdownOpen = !isDropdownOpen;
        
        if (isDropdownOpen) {
            profileDropdown.classList.remove('hidden');
        } else {
            profileDropdown.classList.add('hidden');
        }
    });
    
    document.addEventListener('click', (e) => {
        if (isDropdownOpen && !profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
            profileDropdown.classList.add('hidden');
            isDropdownOpen = false;
        }
    });
    
    // Handle sign out
    const signOutButton = document.getElementById('signOutButton');
    if (signOutButton) {
        signOutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                showToast('Signed out successfully', 'success');
                
                // Redirect to login page after a brief delay
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
                
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Failed to sign out', 'error');
            }
        });
    }
}

// Function to handle language dropdown
function setupLanguageDropdown() {
    const langToggle = document.getElementById('lang-toggle');
    const langPanel = document.getElementById('lang-panel');
    const langButtons = document.querySelectorAll('.lang-button');
    const currentLangSpan = document.getElementById('current-lang');
    
    if (!langToggle || !langPanel) return;
    
    // Toggle dropdown when button is clicked
    langToggle.addEventListener('click', function() {
        langPanel.classList.toggle('hidden');
    });
    
    // Handle language selection
    langButtons.forEach(button => {
        button.addEventListener('click', function() {
            const lang = this.getAttribute('data-lang');
            currentLangSpan.textContent = lang;
            
            // Close dropdown
            langPanel.classList.add('hidden');
            
            // Here you would trigger language change in your app
            // setLanguage(lang);
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('#lang-dropdown')) {
            langPanel.classList.add('hidden');
        }
    });
}

// Function to setup dark mode toggle
function setupDarkMode() {
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (!darkModeToggle) return;
    
    // Check for saved preference
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    
    // Apply initial dark mode if needed
    if (isDarkMode) {
        document.documentElement.classList.add('dark');
    }
    
    // Toggle dark mode on click
    darkModeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark);
    });
}

// Initialize dashboard
async function initDashboard() {
    // Check authentication status
    const { isAuthenticated, user } = await checkAuthStatus();
    
    if (!isAuthenticated) {
        showToast('Please sign in to access the dashboard', 'warning');
        
        // Redirect to login page after a brief delay
        setTimeout(() => {
            window.location.href = 'login.html';
        }, 2000);
        
        return;
    }
    
    // Setup UI components
    setupBannerRotation();
    setupProfileDropdown();
    setupLanguageDropdown();
    setupDarkMode();
    
    // Load data
    loadAnalytics();
    loadRecentActivity();
    loadRecentVideos();
}

// Expose functions for inline button handlers
window.editVideo = function(videoId) {
    window.location.href = `edit-video.html?id=${videoId}`;
};

window.deleteVideo = async function(videoId) {
    if (confirm('Are you sure you want to delete this video? This action cannot be undone.')) {
        try {
            const { error } = await supabase
                .from('videos')
                .delete()
                .eq('id', videoId);
            
            if (error) throw error;
            
            showToast('Video deleted successfully', 'success');
            
            // Reload videos
            loadRecentVideos();
            loadRecentActivity();
            loadAnalytics();
            
        } catch (error) {
            console.error('Error deleting video:', error);
            showToast('Failed to delete video', 'error');
        }
    }
};

// Start initialization when DOM is loaded
document.addEventListener('DOMContentLoaded', initDashboard);
</script>
</body>
</html>
